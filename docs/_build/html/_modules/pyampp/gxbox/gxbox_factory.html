

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyampp.gxbox.gxbox_factory &mdash; pyAMPP 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=938c9ccc"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pyAMPP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../model_hdf5_format.html">pyAMPP HDF5 Model Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gui_workflow.html">pyAMPP GUI Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viewers.html">Model Viewers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html#id1">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyAMPP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyampp.gxbox.gxbox_factory</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyampp.gxbox.gxbox_factory</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">locale</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mcolors</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5.QtWidgets</span><span class="w"> </span><span class="kn">import</span> <span class="n">QApplication</span><span class="p">,</span> <span class="n">QComboBox</span><span class="p">,</span> <span class="n">QCheckBox</span><span class="p">,</span> <span class="n">QFileDialog</span><span class="p">,</span> <span class="n">QGroupBox</span><span class="p">,</span> <span class="n">QHBoxLayout</span><span class="p">,</span> <span class="n">QLabel</span><span class="p">,</span> <span class="n">QLineEdit</span><span class="p">,</span> \
    <span class="n">QMainWindow</span><span class="p">,</span> \
    <span class="n">QPushButton</span><span class="p">,</span> <span class="n">QVBoxLayout</span><span class="p">,</span> <span class="n">QWidget</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">PyQt5</span><span class="w"> </span><span class="kn">import</span> <span class="n">uic</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">colormaps</span> <span class="k">as</span> <span class="n">mplcmaps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_qt5agg</span><span class="w"> </span><span class="kn">import</span> <span class="n">FigureCanvasQTAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.backends.backend_qt5agg</span><span class="w"> </span><span class="kn">import</span> <span class="n">NavigationToolbar2QT</span> <span class="k">as</span> <span class="n">NavigationToolbar</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyAMaFiL.mag_field_proc</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagFieldProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyAMaFiL.mag_field_lin_fff</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagFieldLinFFF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sunpy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">Heliocentric</span><span class="p">,</span> <span class="n">HeliographicStonyhurst</span><span class="p">,</span> <span class="n">HeliographicCarrington</span><span class="p">,</span> <span class="n">Helioprojective</span><span class="p">,</span> <span class="n">get_earth</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sunpy.sun</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">sun_consts</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sunpy.map</span><span class="w"> </span><span class="kn">import</span> <span class="n">Map</span><span class="p">,</span> <span class="n">coordinate_is_on_solar_disk</span><span class="p">,</span> <span class="n">make_fitswcs_header</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pyampp</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">downloader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.box</span><span class="w"> </span><span class="kn">import</span> <span class="n">Box</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gx_chromo.decompose</span><span class="w"> </span><span class="kn">import</span> <span class="n">decompose</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.boxutils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">hmi_b2ptr</span><span class="p">,</span>
    <span class="n">hmi_disambig</span><span class="p">,</span>
    <span class="n">read_b3d_h5</span><span class="p">,</span>
    <span class="n">write_b3d_h5</span><span class="p">,</span>
    <span class="n">compute_vertical_current</span><span class="p">,</span>
    <span class="n">load_sunpy_map_compat</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.gx_box2id</span><span class="w"> </span><span class="kn">import</span> <span class="n">gx_box2id</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.magfield_viewer</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagFieldViewer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.util.config</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Optional</span>

<div class="viewcode-block" id="app">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.app">[docs]</a>
<span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run GxBox with specified parameters.&quot;</span><span class="p">)</span></div>


<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;OMP_NUM_THREADS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;16&#39;</span>  <span class="c1"># number of parallel threads</span>
<span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">);</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_index_header</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">source_map</span><span class="p">:</span> <span class="n">Map</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an IDL-GX compatible INDEX-like FITS header string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">ctype1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">ctype2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ctype1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HGLN-&quot;</span><span class="p">):</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRLN-&quot;</span> <span class="o">+</span> <span class="n">ctype1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ctype2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HGLT-&quot;</span><span class="p">):</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRLT-&quot;</span> <span class="o">+</span> <span class="n">ctype2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;SIMPLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SIMPLE&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAXIS&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">source_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date_obs</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isot</span> <span class="k">if</span> <span class="n">source_map</span><span class="o">.</span><span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">date_obs</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
        <span class="k">elif</span> <span class="s2">&quot;DATE-OBS&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;DATE_OBS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source_map</span><span class="p">,</span> <span class="s2">&quot;dsun&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">source_map</span><span class="o">.</span><span class="n">dsun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DSUN_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">source_map</span><span class="o">.</span><span class="n">dsun</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">observer_coordinate</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_hgs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicStonyhurst</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">source_map</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;HGLN_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgs</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;HGLT_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgs</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;SOLAR_B0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgs</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obs_hgc</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicCarrington</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">source_map</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRLN_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgc</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRLT_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgc</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># Carrington observer transforms can fail for some observer metadata;</span>
                <span class="c1"># keep header generation robust and proceed with available keys.</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source_map</span><span class="p">,</span> <span class="s2">&quot;rsun_meters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;RSUN_REF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">source_map</span><span class="o">.</span><span class="n">rsun_meters</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>

        <span class="n">tel</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;telescop&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tel</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tel</span><span class="p">)</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instrume&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instr</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;WCSNAME&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;WCSNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Carrington-Heliographic&quot;</span>

    <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="c1">## todo add chrom mask to the tool</span>
<div class="viewcode-block" id="GxBox">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">GxBox</span><span class="p">(</span><span class="n">QMainWindow</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">observer</span><span class="p">,</span> <span class="n">box_orig</span><span class="p">,</span> <span class="n">box_dims</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">,</span>
                 <span class="n">box_res</span><span class="o">=</span><span class="mf">1.4</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span><span class="p">,</span> <span class="n">pad_frac</span><span class="o">=</span><span class="mf">0.10</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">DOWNLOAD_DIR</span><span class="p">,</span> <span class="n">gxmodel_dir</span><span class="o">=</span><span class="n">GXMODEL_DIR</span><span class="p">,</span>
                 <span class="n">external_box</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">execute_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">save_empty_box</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_nas</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_gen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">save_chr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">stop_after</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">auto_visualize_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">euv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">uv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">hmifiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">entry_box</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">empty_box_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">potential_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">use_potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">jump2potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">jump2nlfff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">jump2lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">jump2chromo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main application window for visualizing and interacting with solar data in a 3D box.</span>

<span class="sd">        :param time: Observation time.</span>
<span class="sd">        :type time: `~astropy.time.Time`</span>
<span class="sd">        :param observer: Observer location.</span>
<span class="sd">        :type observer: `~astropy.coordinates.SkyCoord`</span>
<span class="sd">        :param box_orig: The origin of the box (center of the box bottom).</span>
<span class="sd">        :type box_orig: `~astropy.coordinates.SkyCoord`</span>
<span class="sd">        :param box_dims: Dimensions of the box in pixels (x, y, z) in the specified units. x and y are in the hpc frame, z is the height above the solar surface.</span>
<span class="sd">        :type box_dims: `~astropy.units.Quantity`</span>
<span class="sd">        :param box_res: Spatial resolution of the box, defaults to 1.4 Mm.</span>
<span class="sd">        :type box_res: `~astropy.units.Quantity`</span>
<span class="sd">        :param pad_frac: Fractional padding applied to each side of the box, expressed as a decimal, defaults to 0.25.</span>
<span class="sd">        :type pad_frac: float</span>
<span class="sd">        :param data_dir: Directory for storing data.</span>
<span class="sd">        :type data_dir: str</span>
<span class="sd">        :param gxmodel_dir: Directory for storing model outputs.</span>
<span class="sd">        :type gxmodel_dir: str</span>
<span class="sd">        :param external_box: Path to external box file (optional).</span>
<span class="sd">        :type external_box: str</span>

<span class="sd">        Methods</span>
<span class="sd">        -------</span>
<span class="sd">        loadmap(mapname, fov_coords=None)</span>
<span class="sd">            Loads a map from the available data.</span>
<span class="sd">        init_ui()</span>
<span class="sd">            Initializes the user interface.</span>
<span class="sd">        update_bottom_map(map_name)</span>
<span class="sd">            Updates the bottom map displayed in the UI.</span>
<span class="sd">        update_context_map(map_name)</span>
<span class="sd">            Updates the context map displayed in the UI.</span>
<span class="sd">        update_plot()</span>
<span class="sd">            Updates the plot with the current data and settings.</span>
<span class="sd">        create_lines_of_sight()</span>
<span class="sd">            Creates lines of sight for the visualization.</span>
<span class="sd">        visualize()</span>
<span class="sd">            Visualizes the data in the UI.</span>

<span class="sd">        Example</span>
<span class="sd">        -------</span>
<span class="sd">        &gt;&gt;&gt; from astropy.time import Time</span>
<span class="sd">        &gt;&gt;&gt; from astropy.coordinates import SkyCoord</span>
<span class="sd">        &gt;&gt;&gt; import astropy.units as u</span>
<span class="sd">        &gt;&gt;&gt; from pyampp.gxbox import GxBox</span>
<span class="sd">        &gt;&gt;&gt; time = Time(&#39;2024-05-09T17:12:00&#39;)</span>
<span class="sd">        &gt;&gt;&gt; observer = SkyCoord(0 * u.deg, 0 * u.deg, obstime=time, frame=&#39;heliographic_carrington&#39;)</span>
<span class="sd">        &gt;&gt;&gt; box_orig = SkyCoord(450 * u.arcsec, -256 * u.arcsec, obstime=time, observer=&quot;earth&quot;, frame=&#39;helioprojective&#39;)</span>
<span class="sd">        &gt;&gt;&gt; box_dims = u.Quantity([100, 100, 100], u.pix)</span>
<span class="sd">        &gt;&gt;&gt; box_res = 1.4 * u.Mm</span>
<span class="sd">        &gt;&gt;&gt; gxbox = GxBox(time, observer, box_orig, box_dims, box_res)</span>
<span class="sd">        &gt;&gt;&gt; gxbox.show()</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GxBox</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
<div class="viewcode-block" id="GxBox.time">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.time">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span></div>

<div class="viewcode-block" id="GxBox.observer">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.observer">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">observer</span> <span class="o">=</span> <span class="n">observer</span></div>

<div class="viewcode-block" id="GxBox.box_dims">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.box_dims">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_dims</span> <span class="o">=</span> <span class="n">box_dims</span></div>

<div class="viewcode-block" id="GxBox.box_res">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.box_res">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_res</span> <span class="o">=</span> <span class="n">box_res</span></div>

<div class="viewcode-block" id="GxBox.pad_frac">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.pad_frac">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">pad_frac</span> <span class="o">=</span> <span class="n">pad_frac</span></div>

        <span class="c1">## this is the origin of the box, i.e., the center of the box bottom</span>
<div class="viewcode-block" id="GxBox.box_origin">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.box_origin">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span> <span class="o">=</span> <span class="n">box_orig</span></div>

<div class="viewcode-block" id="GxBox.gxmodel_dir">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.gxmodel_dir">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">gxmodel_dir</span> <span class="o">=</span> <span class="n">gxmodel_dir</span></div>

<div class="viewcode-block" id="GxBox.auto_save_stages">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.auto_save_stages">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_save_stages</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GxBox.execute_cmd">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.execute_cmd">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span> <span class="o">=</span> <span class="n">execute_cmd</span></div>

<div class="viewcode-block" id="GxBox.save_empty_box">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_empty_box">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_empty_box</span> <span class="o">=</span> <span class="n">save_empty_box</span></div>

<div class="viewcode-block" id="GxBox.save_bounds">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_bounds">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_bounds</span> <span class="o">=</span> <span class="n">save_bounds</span></div>

<div class="viewcode-block" id="GxBox.save_potential">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_potential">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_potential</span> <span class="o">=</span> <span class="n">save_potential</span></div>

<div class="viewcode-block" id="GxBox.save_nas">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_nas">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_nas</span> <span class="o">=</span> <span class="n">save_nas</span></div>

<div class="viewcode-block" id="GxBox.save_gen">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_gen">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_gen</span> <span class="o">=</span> <span class="n">save_gen</span></div>

<div class="viewcode-block" id="GxBox.save_chr">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_chr">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_chr</span> <span class="o">=</span> <span class="n">save_chr</span></div>

<div class="viewcode-block" id="GxBox.stop_after">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.stop_after">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="n">stop_after</span></div>

<div class="viewcode-block" id="GxBox.auto_visualize_last">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.auto_visualize_last">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">auto_visualize_last</span> <span class="o">=</span> <span class="n">auto_visualize_last</span></div>

<div class="viewcode-block" id="GxBox.euv">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.euv">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">euv</span> <span class="o">=</span> <span class="n">euv</span></div>

<div class="viewcode-block" id="GxBox.uv">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.uv">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">uv</span></div>

<div class="viewcode-block" id="GxBox.hmifiles">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.hmifiles">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">hmifiles</span> <span class="o">=</span> <span class="n">hmifiles</span></div>

<div class="viewcode-block" id="GxBox.entry_box">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.entry_box">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">entry_box</span> <span class="o">=</span> <span class="n">entry_box</span></div>

<div class="viewcode-block" id="GxBox.empty_box_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.empty_box_only">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">empty_box_only</span> <span class="o">=</span> <span class="n">empty_box_only</span></div>

<div class="viewcode-block" id="GxBox.potential_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.potential_only">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">potential_only</span> <span class="o">=</span> <span class="n">potential_only</span></div>

<div class="viewcode-block" id="GxBox.use_potential">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.use_potential">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_potential</span> <span class="o">=</span> <span class="n">use_potential</span></div>

<div class="viewcode-block" id="GxBox.jump2potential">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.jump2potential">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">jump2potential</span> <span class="o">=</span> <span class="n">jump2potential</span></div>

<div class="viewcode-block" id="GxBox.jump2nlfff">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.jump2nlfff">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">jump2nlfff</span> <span class="o">=</span> <span class="n">jump2nlfff</span></div>

<div class="viewcode-block" id="GxBox.jump2lines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.jump2lines">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">jump2lines</span> <span class="o">=</span> <span class="n">jump2lines</span></div>

<div class="viewcode-block" id="GxBox.jump2chromo">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.jump2chromo">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">jump2chromo</span> <span class="o">=</span> <span class="n">jump2chromo</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">_visualizing_last</span> <span class="o">=</span> <span class="kc">False</span>
<div class="viewcode-block" id="GxBox.sdofitsfiles">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.sdofitsfiles">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span> <span class="o">=</span> <span class="kc">None</span></div>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;observer:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="p">)</span>
<div class="viewcode-block" id="GxBox.frame_hcc">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.frame_hcc">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_hcc</span> <span class="o">=</span> <span class="n">Heliocentric</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="GxBox.frame_obs">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.frame_obs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_obs</span> <span class="o">=</span> <span class="n">Helioprojective</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="GxBox.frame_hgs">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.frame_hgs">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">frame_hgs</span> <span class="o">=</span> <span class="n">HeliographicStonyhurst</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span></div>

<div class="viewcode-block" id="GxBox.lines_of_sight">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.lines_of_sight">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines_of_sight</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="GxBox.edge_coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.edge_coords">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_coords</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="GxBox.axes">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.axes">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GxBox.fig">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.fig">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GxBox.axes_world_coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.axes_world_coords">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes_world_coords</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GxBox.axes_world_coords_init">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.axes_world_coords_init">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes_world_coords_init</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GxBox.init_map_context_name">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.init_map_context_name">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_map_context_name</span> <span class="o">=</span> <span class="s1">&#39;171&#39;</span></div>

<div class="viewcode-block" id="GxBox.init_map_bottom_name">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.init_map_bottom_name">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_map_bottom_name</span> <span class="o">=</span> <span class="s1">&#39;field&#39;</span></div>

<div class="viewcode-block" id="GxBox.external_box">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.external_box">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_box</span> <span class="o">=</span> <span class="n">external_box</span></div>

<div class="viewcode-block" id="GxBox.fieldlines_coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.fieldlines_coords">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_coords</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="GxBox.fieldlines_line_collection">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.fieldlines_line_collection">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Initialize an empty list to store LineCollections</span></div>

<div class="viewcode-block" id="GxBox.fieldlines_show_status">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.fieldlines_show_status">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Initial status of the fieldlines visibility</span></div>

<div class="viewcode-block" id="GxBox.map_context_im">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.map_context_im">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context_im</span> <span class="o">=</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="GxBox.map_bottom_im">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.map_bottom_im">[docs]</a>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom_im</span> <span class="o">=</span> <span class="kc">None</span></div>

        <span class="bp">self</span><span class="o">.</span><span class="n">_base_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refmaps_cache</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stage_output_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">date_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">date_str</span>
        <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out_dir</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_format_coord_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicCarrington</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;CR&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">coord</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicStonyhurst</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot;HG&quot;</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">lat</span> <span class="o">=</span> <span class="n">coord</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">)</span>
        <span class="n">lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.0</span> <span class="o">-</span> <span class="mf">180.0</span>
        <span class="n">lon_dir</span> <span class="o">=</span> <span class="s2">&quot;W&quot;</span> <span class="k">if</span> <span class="n">lon</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;E&quot;</span>
        <span class="n">lat_dir</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span> <span class="k">if</span> <span class="n">lat</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;S&quot;</span>
        <span class="n">lon_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lon</span><span class="p">)))</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">lat_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lat</span><span class="p">)))</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lon_dir</span><span class="si">}{</span><span class="n">lon_val</span><span class="si">}{</span><span class="n">lat_dir</span><span class="si">}{</span><span class="n">lat_val</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stage_file_base</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">time_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
        <span class="n">coord_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_format_coord_tag</span><span class="p">()</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;hmi.M_720s.</span><span class="si">{</span><span class="n">time_tag</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">coord_tag</span><span class="si">}</span><span class="s2">.CEA&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_stage_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage_output_dir</span><span class="p">()</span>
        <span class="n">base</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage_file_base</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">stage_tag</span><span class="si">}</span><span class="s2">.h5&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_lines_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lines</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dr3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dr3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;start_idx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;end_idx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;seed_idx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;apex_idx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;codes&quot;</span><span class="p">,</span>
            <span class="s2">&quot;av_field&quot;</span><span class="p">,</span>
            <span class="s2">&quot;phys_length&quot;</span><span class="p">,</span>
            <span class="s2">&quot;voxel_status&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">group</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">group</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_chromo_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chromo_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">group</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="s2">&quot;chromo_idx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chromo_n&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chromo_t&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_p&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_hi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;n_htot&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tr&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tr_h&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chromo_layers&quot;</span><span class="p">,</span>
            <span class="s2">&quot;dz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;chromo_mask&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">chromo_box</span><span class="p">:</span>
                <span class="n">group</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_box</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">chromo_bcube</span> <span class="o">=</span> <span class="n">chromo_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromo_bcube&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chromo_bcube</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">chromo_bcube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">chromo_bcube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">group</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_bcube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">group</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_bcube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_bcube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">group</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_h5_2d</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot normalize 2D map shape </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to (ny,nx)=(</span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_h5_3d</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot normalize 3D cube shape </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to (nz,ny,nx) with (ny,nx)=(</span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_stage_for_h5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stage_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;base&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">out</span>
        <span class="n">base</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;bx&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
            <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">elif</span> <span class="s2">&quot;bz&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
            <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">,</span> <span class="s2">&quot;ic&quot;</span><span class="p">,</span> <span class="s2">&quot;chromo_mask&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
                <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_h5_2d</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>

        <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">corona</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">corona</span><span class="p">:</span>
                    <span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_h5_3d</span><span class="p">(</span><span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corona</span>

        <span class="k">if</span> <span class="s2">&quot;chromo&quot;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">chromo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">,</span> <span class="s2">&quot;dz&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chromo</span><span class="p">:</span>
                    <span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_h5_3d</span><span class="p">(</span><span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">,</span> <span class="s2">&quot;tr_h&quot;</span><span class="p">,</span> <span class="s2">&quot;chromo_mask&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chromo</span><span class="p">:</span>
                    <span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_h5_2d</span><span class="p">(</span><span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo</span>

        <span class="k">if</span> <span class="s2">&quot;grid&quot;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;voxel_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dz&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">grid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_to_h5_3d</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_last_stage_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="p">:</span>
            <span class="n">stop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="s2">&quot;empty_box&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bnd&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;pot&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;nas&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;gen&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;NAS.GEN&quot;</span>
            <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;chr&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;NAS.CHR&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;NAS.CHR&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_should_save_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_stage_tag</span><span class="p">():</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_potential</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_nas</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;NAS.GEN&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_gen</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;NAS.CHR&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_chr</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_empty_box</span>
        <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_bounds</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_rsun_km</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">:</span>
        <span class="n">rsun</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rsun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rsun_ref&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rsun</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rsun</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rsun_ref&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rsun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">rsun</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sun_consts</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_open_last_viewer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_visualizing_last</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_visualizing_last</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corona&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromo&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b3dModelSelector</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="s2">&quot;pot&quot;</span><span class="p">)</span>
                <span class="n">b3dtype</span> <span class="o">=</span> <span class="s2">&quot;pot&quot;</span>
            <span class="k">elif</span> <span class="n">stage_tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NAS&quot;</span><span class="p">,</span> <span class="s2">&quot;NAS.GEN&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">b3dModelSelector</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="s2">&quot;nlfff&quot;</span><span class="p">)</span>
                <span class="n">b3dtype</span> <span class="o">=</span> <span class="s2">&quot;nlfff&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">b3dtype</span> <span class="o">=</span> <span class="s2">&quot;chromo&quot;</span>
            <span class="n">box_norm_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_norm_direction</span><span class="p">()</span>
            <span class="n">box_view_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_view_up</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="o">=</span> <span class="n">MagFieldViewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_norm_direction</span><span class="o">=</span><span class="n">box_norm_direction</span><span class="p">,</span>
                                             <span class="n">box_view_up</span><span class="o">=</span><span class="n">box_view_up</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">b3dtype</span><span class="o">=</span><span class="n">b3dtype</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_visualizing_last</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_empty_box</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obs_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_res</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsun_km</span><span class="p">()</span>
        <span class="n">dr3</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">dims_pix</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nz</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">empty</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">empty</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">empty</span><span class="p">,</span> <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dr3</span><span class="p">),</span>
                                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">}}}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stage</span><span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">stage_box</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">map_bz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">)</span>
        <span class="c1"># Match GX/IDL base convention: bx := bp, by := -bt.</span>
        <span class="n">map_bx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;bp&quot;</span><span class="p">)</span>
        <span class="n">map_by</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;bt&quot;</span><span class="p">)</span>
        <span class="n">map_bz</span> <span class="o">=</span> <span class="n">map_bz</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">map_bx</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">map_by</span> <span class="o">=</span> <span class="n">map_by</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">obs_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_res</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsun_km</span><span class="p">()</span>
        <span class="n">dr3</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">map_by</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">map_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dr3</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stage</span><span class="p">(</span><span class="s2">&quot;BND&quot;</span><span class="p">,</span> <span class="n">stage_box</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_base_group</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_cache</span>
        <span class="c1"># Match GX/IDL base convention: bx := bp, by := -bt.</span>
        <span class="n">map_bx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;bp&quot;</span><span class="p">)</span>
        <span class="n">map_by</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;bt&quot;</span><span class="p">)</span>
        <span class="n">map_bz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">)</span>
        <span class="n">map_ic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;continuum&quot;</span><span class="p">)</span>
        <span class="n">map_bx</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">map_by</span> <span class="o">=</span> <span class="n">map_by</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">map_bz</span> <span class="o">=</span> <span class="n">map_bz</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">map_ic</span> <span class="o">=</span> <span class="n">map_ic</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">_build_index_header</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">map_bz</span><span class="p">)</span>
        <span class="n">chromo_mask</span> <span class="o">=</span> <span class="n">decompose</span><span class="p">(</span><span class="n">map_bz</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">map_ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_base_cache</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">map_by</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">map_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;ic&quot;</span><span class="p">:</span> <span class="n">map_ic</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;chromo_mask&quot;</span><span class="p">:</span> <span class="n">chromo_mask</span><span class="p">,</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_base_cache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_refmaps</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refmaps_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refmaps_cache</span>
        <span class="n">refmaps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">add_refmap</span><span class="p">(</span><span class="n">ref_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">smap</span><span class="p">:</span> <span class="n">Map</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Use WCS header only to avoid non-ASCII FITS meta from some sources.</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
            <span class="n">refmaps</span><span class="p">[</span><span class="n">ref_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">smap</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;wcs_header&quot;</span><span class="p">:</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>

        <span class="n">add_refmap</span><span class="p">(</span><span class="s2">&quot;Bz_reference&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">))</span>
        <span class="n">add_refmap</span><span class="p">(</span><span class="s2">&quot;Ic_reference&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;continuum&quot;</span><span class="p">))</span>

        <span class="n">vert_current_error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Match GX/IDL base convention: bx := bp, by := -bt.</span>
            <span class="n">map_bx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;bp&quot;</span><span class="p">)</span>
            <span class="n">map_by</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;bt&quot;</span><span class="p">)</span>
            <span class="n">map_bz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;br&quot;</span><span class="p">)</span>
            <span class="n">vc_header</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rsun_arcsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rsun_obs</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
            <span class="n">crpix1</span><span class="p">,</span> <span class="n">crpix2</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span>
            <span class="n">cdelt1</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
            <span class="n">cdelt2</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
            <span class="n">jz</span> <span class="o">=</span> <span class="n">compute_vertical_current</span><span class="p">(</span><span class="n">map_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">map_by</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">vc_header</span><span class="p">,</span> <span class="n">rsun_arcsec</span><span class="p">,</span>
                                          <span class="n">crpix1</span><span class="o">=</span><span class="n">crpix1</span><span class="p">,</span> <span class="n">crpix2</span><span class="o">=</span><span class="n">crpix2</span><span class="p">,</span>
                                          <span class="n">cdelt1_arcsec</span><span class="o">=</span><span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2_arcsec</span><span class="o">=</span><span class="n">cdelt2</span><span class="p">)</span>
            <span class="n">refmaps</span><span class="p">[</span><span class="s2">&quot;Vert_current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">jz</span><span class="p">,</span> <span class="s2">&quot;wcs_header&quot;</span><span class="p">:</span> <span class="n">vc_header</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">vert_current_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">AIA_EUV_PASSBANDS</span> <span class="o">+</span> <span class="n">AIA_UV_PASSBANDS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pb</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="p">:</span>
                <span class="n">add_refmap</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AIA_</span><span class="si">{</span><span class="n">pb</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="n">pb</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">vert_current_error</span><span class="p">:</span>
            <span class="n">refmaps</span><span class="p">[</span><span class="s2">&quot;_vert_current_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">vert_current_error</span><span class="p">]),</span>
                                               <span class="s2">&quot;wcs_header&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_refmaps_cache</span> <span class="o">=</span> <span class="n">refmaps</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refmaps_cache</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stage_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_save_stages</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_save_stage</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage_filename</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">)</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stage_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;base&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_base_group</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;refmaps&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;refmaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_refmaps</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">corona</span> <span class="o">=</span> <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span>
            <span class="n">voxel_id</span><span class="p">,</span> <span class="n">corona_base</span> <span class="o">=</span> <span class="n">gx_box2id</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">corona</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">stage_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">),</span> <span class="s2">&quot;chromo&quot;</span><span class="p">:</span> <span class="n">stage_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromo&quot;</span><span class="p">)},</span>
                <span class="n">return_corona_base</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">corona_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">corona</span><span class="p">[</span><span class="s2">&quot;corona_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">corona_base</span><span class="p">)</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corona</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corona</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dr&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;dx&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;dy&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;dz&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">dr</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
                <span class="s2">&quot;voxel_id&quot;</span><span class="p">:</span> <span class="n">voxel_id</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;chromo&quot;</span> <span class="ow">in</span> <span class="n">stage_box</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;dz&quot;</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">]:</span>
                <span class="n">grid</span><span class="p">[</span><span class="s2">&quot;dz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">][</span><span class="s2">&quot;dz&quot;</span><span class="p">]</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="n">stage_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_stage_file_base</span><span class="p">()</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">stage_tag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;execute&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_cmd</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">stage_id</span><span class="p">,</span>
                <span class="s2">&quot;axis_order_2d&quot;</span><span class="p">:</span> <span class="s2">&quot;yx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;axis_order_3d&quot;</span><span class="p">:</span> <span class="s2">&quot;zyx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vector_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;split_components&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">stage_id</span><span class="p">,</span>
                <span class="s2">&quot;axis_order_2d&quot;</span><span class="p">:</span> <span class="s2">&quot;yx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;axis_order_3d&quot;</span><span class="p">:</span> <span class="s2">&quot;zyx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;vector_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;split_components&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_stage_for_h5</span><span class="p">(</span><span class="n">stage_box</span><span class="p">)</span>
        <span class="n">write_b3d_h5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">stage_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_visualize_last</span> <span class="ow">and</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_stage_tag</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_last_viewer</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">box_dimensions</span> <span class="o">=</span> <span class="n">box_dims</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span> <span class="o">*</span> <span class="n">box_res</span>

        <span class="c1">## this is a dummy map. it should be replaced by a real map from inputs.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instrument_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_dummy_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_obs</span><span class="p">))</span>

        <span class="n">box_center</span> <span class="o">=</span> <span class="n">box_orig</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_hcc</span><span class="p">)</span>
        <span class="n">box_center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">box_center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                              <span class="n">y</span><span class="o">=</span><span class="n">box_center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                              <span class="n">z</span><span class="o">=</span><span class="n">box_center</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="n">box_dimensions</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                              <span class="n">frame</span><span class="o">=</span><span class="n">box_center</span><span class="o">.</span><span class="n">frame</span><span class="p">)</span>
        <span class="c1">## this is the center of the box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_center</span> <span class="o">=</span> <span class="n">box_center</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_obs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_dims</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_res</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">bounds_coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">bottom_cea_header</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fov_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">bounds_coords_bl_tr</span><span class="p">(</span><span class="n">pad_frac</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pad_frac</span><span class="p">)</span>
        <span class="c1"># print(f&quot;Bottom left: {self.fov_coords[0]}; Top right: {self.fov_coords[1]}&quot;)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">coordinate_is_on_solar_disk</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="k">for</span> <span class="n">coord</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_coords</span><span class="p">]):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Some of the box corners are not on the solar disk. Please check the box dimensions.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hmifiles</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hmifiles</span>
        <span class="n">download_sdo</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">SDOImageDownloader</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span> <span class="n">euv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">euv</span><span class="p">,</span> <span class="n">uv</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span> <span class="o">=</span> <span class="n">download_sdo</span><span class="o">.</span><span class="n">download_images</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_context_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_context_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_context_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">[</span><span class="s1">&#39;rsun_ref&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;rsun_ref&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_bottom_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_bottom_name</span><span class="p">)</span>

        <span class="c1"># print(self.bottom_wcs_header)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_bottom_name</span><span class="p">]</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span>
                                                                               <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
                                                                               <span class="n">roundtrip_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_empty_box</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_empty_box</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_bounds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_bounds</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_ui</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_box</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_gxbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entry_box</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jump2potential</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="s2">&quot;pot&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_potential_field</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">jump2nlfff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="s2">&quot;nas&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_nlfff</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">jump2lines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="s2">&quot;gen&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_nlfff</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">jump2chromo</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="s2">&quot;chr&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_nlfff</span><span class="p">()</span>

<div class="viewcode-block" id="GxBox.box_norm_direction">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.box_norm_direction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">box_norm_direction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cartesian_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
            <span class="n">Heliocentric</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">xyz</span><span class="o">.</span><span class="n">value</span>
        <span class="n">normal_vector</span> <span class="o">=</span> <span class="n">cartesian_coords</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">normal_vector</span></div>


    <span class="c1"># def box_norm_direction(self):</span>
    <span class="c1">#     cartesian_coords = np.diff(self.box.box_norm_direction.transform_to(Heliocentric(observer=self.observer, obstime=self.time)).cartesian.xyz).value</span>
    <span class="c1">#     normal_vector = np.squeeze(cartesian_coords / np.linalg.norm(cartesian_coords))</span>
    <span class="c1">#     normal_vector = normal_vector[1]/abs(normal_vector[1])*normal_vector</span>
    <span class="c1">#     return normal_vector</span>

<div class="viewcode-block" id="GxBox.box_view_up">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.box_view_up">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">box_view_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cartesian_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">box_view_up</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span>
            <span class="n">Heliocentric</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">observer</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">))</span><span class="o">.</span><span class="n">cartesian</span><span class="o">.</span><span class="n">xyz</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">normal_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">cartesian_coords</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">cartesian_coords</span><span class="p">))</span>
        <span class="n">normal_vector</span> <span class="o">=</span> <span class="n">normal_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">normal_vector</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">normal_vector</span>
        <span class="k">return</span> <span class="n">normal_vector</span></div>


<div class="viewcode-block" id="GxBox.load_gxbox">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.load_gxbox">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_gxbox</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">boxfile</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">boxfile</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.gxbox&#39;</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">boxfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">gxboxdata</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                <span class="n">b3d</span> <span class="o">=</span> <span class="n">gxboxdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;b3d&#39;</span><span class="p">,</span> <span class="p">{})</span>
                <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="n">b3d</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="n">b3d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corona&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="s2">&quot;nlfff&quot;</span> <span class="ow">in</span> <span class="n">b3d</span> <span class="ow">or</span> <span class="s2">&quot;pot&quot;</span> <span class="ow">in</span> <span class="n">b3d</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nlfff&quot;</span><span class="p">,</span> <span class="s2">&quot;pot&quot;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="n">b3d</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3d</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">b3d</span><span class="p">[</span><span class="n">model_type</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="n">model_type</span>
                            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">boxfile</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span> <span class="o">=</span> <span class="n">read_b3d_h5</span><span class="p">(</span><span class="n">boxfile</span><span class="p">)</span>
            <span class="n">axis_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;axis_order_3d&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">axis_order</span> <span class="o">==</span> <span class="s2">&quot;zyx&quot;</span> <span class="ow">and</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">:</span>
                <span class="n">corona</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">corona</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="c1"># Convert storage canonical (z,y,x) -&gt; internal compute (x,y,z)</span>
                        <span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corona</span>
            <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pot&quot;</span><span class="p">,</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="GxBox.avaliable_maps">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.avaliable_maps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">avaliable_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Lists the available maps.</span>

<span class="sd">        :return: A list of available map keys.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">HMI_B_SEGMENTS</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">+</span> <span class="n">HMI_B_PRODUCTS</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.corr_fov_coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.corr_fov_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">corr_fov_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sunpymap</span><span class="p">,</span> <span class="n">fov_coords</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Corrects the field of view coordinates using the given map.</span>
<span class="sd">        :param sunpymap: The map to use for correction.</span>
<span class="sd">        :type sunpymap: sunpy.map.Map</span>
<span class="sd">        :param fov_coords: The field of view coordinates (bottom left and top right) as SkyCoord objects.</span>
<span class="sd">        :type fov_coords: list</span>

<span class="sd">        :return: Corrected field of view coordinates.</span>
<span class="sd">        :rtype: list</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">fov_coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">SkyCoord</span><span class="p">(</span><span class="n">Tx</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Tx</span><span class="p">,</span> <span class="n">Ty</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">Ty</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">sunpymap</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="p">),</span>
                      <span class="n">SkyCoord</span><span class="p">(</span><span class="n">Tx</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Tx</span><span class="p">,</span> <span class="n">Ty</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Ty</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">sunpymap</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">fov_coords</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_load_hmi_b_seg_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapname</span><span class="p">,</span> <span class="n">fov_coords</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load specific HMI B segment maps required for the magnetic field vector data products.</span>

<span class="sd">        :param mapname: Name of the map to load.</span>
<span class="sd">        :type mapname: str</span>
<span class="sd">        :param fov_coords: The field of view coordinates (bottom left and top right) as SkyCoord objects.</span>
<span class="sd">        :type fov_coords: list</span>
<span class="sd">        :return: Loaded map object.</span>
<span class="sd">        :rtype: sunpy.map.Map</span>
<span class="sd">        :raises ValueError: If the map name is not in the expected HMI B segments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">HMI_B_SEGMENTS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mapname: </span><span class="si">{</span><span class="n">mapname</span><span class="si">}</span><span class="s2"> must be one of </span><span class="si">{</span><span class="n">HMI_B_SEGMENTS</span><span class="si">}</span><span class="s2">. Use loadmap method for others.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fov_coords: </span><span class="si">{</span><span class="n">fov_coords</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">loaded_map</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="p">[</span><span class="n">mapname</span><span class="p">])</span>
        <span class="n">fov_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_fov_coords</span><span class="p">(</span><span class="n">loaded_map</span><span class="p">,</span> <span class="n">fov_coords</span><span class="p">)</span>
        <span class="n">loaded_map</span> <span class="o">=</span> <span class="n">loaded_map</span><span class="o">.</span><span class="n">submap</span><span class="p">(</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_right</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># loaded_map = loaded_map.rotate(order=3)</span>
        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;disambig&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;disambig&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="p">[</span><span class="s1">&#39;disambig&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">submap</span><span class="p">(</span>
                    <span class="n">fov_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_right</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="n">loaded_map</span> <span class="o">=</span> <span class="n">hmi_disambig</span><span class="p">(</span><span class="n">loaded_map</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;disambig&#39;</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded_map</span>
        <span class="k">return</span> <span class="n">loaded_map</span>

<div class="viewcode-block" id="GxBox.loadmap">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.loadmap">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">loadmap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapname</span><span class="p">,</span> <span class="n">fov_coords</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads a map from the available data.</span>

<span class="sd">        :param mapname: Name of the map to load.</span>
<span class="sd">        :type mapname: str</span>
<span class="sd">        :param fov_coords: Field of view coordinates (bottom left and top right) as SkyCoord objects, optional. Defaults to the entire FOV if not specified.</span>
<span class="sd">        :type fov_coords: list, optional</span>
<span class="sd">        :return: The requested map.</span>
<span class="sd">        :raises ValueError: If the specified map is not available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Map </span><span class="si">{</span><span class="n">mapname</span><span class="si">}</span><span class="s2"> is not available. mapname must be one of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">fov_coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fov_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fov_coords</span>

        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">in</span> <span class="n">HMI_B_SEGMENTS</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_load_hmi_b_seg_maps</span><span class="p">(</span><span class="n">mapname</span><span class="p">,</span> <span class="n">fov_coords</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mapname</span> <span class="ow">in</span> <span class="n">HMI_B_PRODUCTS</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mapname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">HMI_B_SEGMENTS</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_hmi_b_seg_maps</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">fov_coords</span><span class="p">)</span>

            <span class="n">map_bp</span><span class="p">,</span> <span class="n">map_bt</span><span class="p">,</span> <span class="n">map_br</span> <span class="o">=</span> <span class="n">hmi_b2ptr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;field&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;inclination&#39;</span><span class="p">],</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;azimuth&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;bp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_bp</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;bt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_bt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;br&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_br</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span>

        <span class="c1"># Load general maps</span>
        <span class="n">loaded_map</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sdofitsfiles</span><span class="p">[</span><span class="n">mapname</span><span class="p">])</span>
        <span class="n">fov_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_fov_coords</span><span class="p">(</span><span class="n">loaded_map</span><span class="p">,</span> <span class="n">fov_coords</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span> <span class="o">=</span> <span class="n">loaded_map</span><span class="o">.</span><span class="n">submap</span><span class="p">(</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">top_right</span><span class="o">=</span><span class="n">fov_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">mapname</span><span class="p">]</span></div>


<div class="viewcode-block" id="GxBox.make_dummy_map">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.make_dummy_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">make_dummy_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref_coord</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a dummy map for initialization purposes.</span>

<span class="sd">        :param ref_coord: Reference coordinate for the map.</span>
<span class="sd">        :type ref_coord: `~astropy.coordinates.SkyCoord`</span>
<span class="sd">        :return: The created dummy map.</span>
<span class="sd">        :rtype: sunpy.map.Map</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">instrument_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">))</span>
        <span class="n">instrument_header</span> <span class="o">=</span> <span class="n">make_fitswcs_header</span><span class="p">(</span><span class="n">instrument_data</span><span class="p">,</span>
                                                <span class="n">ref_coord</span><span class="p">,</span>
                                                <span class="n">scale</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Map</span><span class="p">(</span><span class="n">instrument_data</span><span class="p">,</span> <span class="n">instrument_header</span><span class="p">)</span></div>


<div class="viewcode-block" id="GxBox.init_ui">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.init_ui">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_ui</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the user interface for the GxBox application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uic</span><span class="o">.</span><span class="n">loadUi</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;UI&quot;</span> <span class="o">/</span> <span class="s2">&quot;gxbox.ui&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Matplotlib Figure</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvasLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">)</span>

        <span class="c1"># Add Matplotlib Navigation Toolbar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span> <span class="o">=</span> <span class="n">NavigationToolbar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvasLayout</span><span class="o">.</span><span class="n">addWidget</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toolbar</span><span class="p">)</span>

        <span class="c1"># self.controlLayout.SetFixedSize(300)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mapBottomSelector</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapBottomSelector</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_bottom_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapBottomSelector</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_bottom_map</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mapContextSelector</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapContextSelector</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">init_map_context_name</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mapContextSelector</span><span class="o">.</span><span class="n">currentTextChanged</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update_context_map</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visualizeButton</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s2">&quot;Visualize the 3D magnetic field.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizeButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">visualize_3d_magnetic_field</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toggleFieldlinesButton</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s2">&quot;Toggle the visibility of the field lines.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toggleFieldlinesButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toggle_fieldlines_visibility</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearFieldlinesButton</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s2">&quot;Clear the field lines.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clearFieldlinesButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clear_fieldlines</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveFieldlinesButton</span><span class="o">.</span><span class="n">setToolTip</span><span class="p">(</span><span class="s2">&quot;Save the field lines to a file.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saveFieldlinesButton</span><span class="o">.</span><span class="n">clicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_fieldlines</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;fieldlines_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">T%H%M%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">.pkl&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">b3dModelSelector</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b3dModelSelector</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bminClipCheckbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bmaxClipCheckbox</span><span class="o">.</span><span class="n">setChecked</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cmapSelector</span><span class="o">.</span><span class="n">addItems</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">mplcmaps</span><span class="p">)))</span>  <span class="c1"># List all available colormaps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmapSelector</span><span class="o">.</span><span class="n">setCurrentText</span><span class="p">(</span><span class="s2">&quot;viridis&quot;</span><span class="p">)</span>  <span class="c1"># Set a default colormap</span>
        <span class="c1"># self.cmapClipCheckbox.setChecked(False)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_box</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">load_gxbox</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_box</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">dimensions</span><span class="p">)</span>
        <span class="n">map_context_aspect_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">value</span>
        <span class="n">window_width</span> <span class="o">=</span> <span class="mi">900</span>
        <span class="n">window_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_width</span> <span class="o">*</span> <span class="n">map_context_aspect_ratio</span><span class="p">)</span>

        <span class="c1"># Adjust for padding, toolbar, and potential high DPI scaling</span>
        <span class="n">window_width</span> <span class="o">+=</span> <span class="mi">200</span>  <span class="c1"># Adjust based on your UI needs</span>
        <span class="n">window_height</span> <span class="o">+=</span> <span class="mi">0</span>  <span class="c1"># Includes space for toolbar and dropdowns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setGeometry</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_width</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">window_height</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">splitter</span><span class="o">.</span><span class="n">setSizes</span><span class="p">([</span><span class="mi">900</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span></div>


<div class="viewcode-block" id="GxBox.calc_potential_field">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.calc_potential_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_potential_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting potential field computation...&#39;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapBottomSelector</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;br&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapBottomSelector</span><span class="o">.</span><span class="n">setCurrentIndex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">avaliable_maps</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">))</span>
        <span class="n">maglib_lff</span> <span class="o">=</span> <span class="n">MagFieldLinFFF</span><span class="p">()</span>
        <span class="n">bnddata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span><span class="o">.</span><span class="n">data</span>
        <span class="n">bnddata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bnddata</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">maglib_lff</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">bnddata</span><span class="p">)</span>
        <span class="c1">## the axis order in res is y, x, z. so we need to swap the first two axes, so that the order becomes x, y, z.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span> <span class="o">=</span> <span class="n">maglib_lff</span><span class="o">.</span><span class="n">LFFF_cube</span><span class="p">(</span><span class="n">nz</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">dims_pix</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time taken to compute potential field solution: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>
        <span class="n">obs_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_res</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsun_km</span><span class="p">()</span>
        <span class="n">dr3</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
        <span class="n">pot_box</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">[</span><span class="s1">&#39;bx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">[</span><span class="s1">&#39;bz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dr3</span><span class="p">),</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pot&quot;</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">[</span><span class="s2">&quot;pot&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="s2">&quot;pot&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stage</span><span class="p">(</span><span class="s2">&quot;POT&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">pot_box</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pot&quot;</span><span class="p">:</span>
            <span class="k">return</span></div>


<div class="viewcode-block" id="GxBox.calc_nlfff">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.calc_nlfff">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_nlfff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.util.compute</span><span class="w"> </span><span class="kn">import</span> <span class="n">cutout2box</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gx_chromo.combo_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">combo_model</span>

        <span class="k">if</span> <span class="s2">&quot;pot&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_potential_field</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pot&quot;</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">pot_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">[</span><span class="s2">&quot;pot&quot;</span><span class="p">]</span>
        <span class="n">bx_lff</span><span class="p">,</span> <span class="n">by_lff</span><span class="p">,</span> <span class="n">bz_lff</span> <span class="o">=</span> <span class="p">[</span><span class="n">pot_box</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">)]</span>
        <span class="c1"># replace bottom boundary of lff solution with initial boundary conditions</span>
        <span class="n">bvect_bottom</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">bvect_bottom</span><span class="p">[</span><span class="s1">&#39;bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;br&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;br&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;br&#39;</span><span class="p">)</span>
        <span class="n">bvect_bottom</span><span class="p">[</span><span class="s1">&#39;bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;bt&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;bt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;bt&#39;</span><span class="p">)</span>
        <span class="n">bvect_bottom</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s1">&#39;bp&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;bp&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s1">&#39;bp&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bvect_bottom</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">bvect_bottom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
                                                                <span class="n">roundtrip_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">bvect_bottom</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">bx_lff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span><span class="p">[</span><span class="s1">&#39;bx&#39;</span><span class="p">]</span>
        <span class="n">by_lff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">]</span>
        <span class="n">bz_lff</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvect_bottom_data</span><span class="p">[</span><span class="s1">&#39;bz&#39;</span><span class="p">]</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Starting NLFFF computation...&#39;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">maglib</span> <span class="o">=</span> <span class="n">MagFieldProcessor</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">[</span><span class="s1">&#39;bx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_box</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_box</span><span class="p">[</span><span class="s1">&#39;bx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">[</span><span class="s1">&#39;bz&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot_box</span><span class="p">[</span><span class="s1">&#39;bz&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">maglib</span><span class="o">.</span><span class="n">load_cube_vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pot_res</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_potential</span><span class="p">:</span>
            <span class="n">bx_nlff</span><span class="p">,</span> <span class="n">by_nlff</span><span class="p">,</span> <span class="n">bz_nlff</span> <span class="o">=</span> <span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">],</span> <span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">],</span> <span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span>
            <span class="n">obs_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_res</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsun_km</span><span class="p">()</span>
            <span class="n">dr3</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
            <span class="n">nlfff_box</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">bx_nlff</span><span class="p">,</span>
                <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">by_nlff</span><span class="p">,</span>
                <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">bz_nlff</span><span class="p">,</span>
                <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dr3</span><span class="p">),</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pot&quot;</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlfff_box</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="s2">&quot;pot&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_nlf</span> <span class="o">=</span> <span class="n">maglib</span><span class="o">.</span><span class="n">NLFFF</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Time taken to compute NLFFF solution: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t0</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1"> seconds&#39;</span><span class="p">)</span>

            <span class="n">bx_nlff</span><span class="p">,</span> <span class="n">by_nlff</span><span class="p">,</span> <span class="n">bz_nlff</span> <span class="o">=</span> <span class="p">[</span><span class="n">res_nlf</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">)]</span>
            <span class="n">obs_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_res</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsun_km</span><span class="p">()</span>
            <span class="n">dr3</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
            <span class="n">nlfff_box</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">bx_nlff</span><span class="p">,</span>
                <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">by_nlff</span><span class="p">,</span>
                <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">bz_nlff</span><span class="p">,</span>
                <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dr3</span><span class="p">),</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">},</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">[</span><span class="s2">&quot;nlfff&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlfff_box</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nlfff_box</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="s2">&quot;nlfff&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_save_stage</span><span class="p">(</span><span class="s2">&quot;NAS&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nas&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">t1</span>  <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating field lines&quot;</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">maglib</span><span class="o">.</span><span class="n">lines</span><span class="p">(</span><span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">reproj</span><span class="p">(</span><span class="n">bottom_map</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bottom_map</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
                                                                <span class="n">roundtrip_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">base_bz</span> <span class="o">=</span> <span class="n">reproj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">))</span>
        <span class="n">base_ic</span> <span class="o">=</span> <span class="n">reproj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="s2">&quot;continuum&quot;</span><span class="p">))</span>

        <span class="n">header_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
        <span class="n">field_frame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">heliographic_carrington</span><span class="o">.</span><span class="n">frame</span>
        <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">field_frame</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">field_frame</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span>

        <span class="n">obs_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_frame_obs</span><span class="o">.</span><span class="n">obstime</span>
        <span class="n">dsun_obs</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">[</span><span class="s2">&quot;DSUN_OBS&quot;</span><span class="p">]</span>
        <span class="n">header</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span> <span class="s2">&quot;dsun_obs&quot;</span><span class="p">:</span> <span class="n">dsun_obs</span><span class="p">,</span> <span class="s2">&quot;obs_time&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obs_time</span><span class="o">.</span><span class="n">iso</span><span class="p">)}</span>

        <span class="n">obs_dr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_res</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rsun_km</span><span class="p">()</span>
        <span class="n">dr3</span> <span class="o">=</span> <span class="p">[</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>

        <span class="n">chromo_box</span> <span class="o">=</span> <span class="n">combo_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s1">&#39;corona&#39;</span><span class="p">],</span> <span class="n">dr3</span><span class="p">,</span> <span class="n">base_bz</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">base_ic</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;codes&quot;</span><span class="p">,</span> <span class="s2">&quot;apex_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;start_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;end_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;seed_idx&quot;</span><span class="p">,</span>\
                  <span class="s2">&quot;av_field&quot;</span><span class="p">,</span> <span class="s2">&quot;phys_length&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel_status&quot;</span><span class="p">]:</span>
            <span class="n">chromo_box</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">chromo_box</span><span class="p">[</span><span class="s2">&quot;phys_length&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">dr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chromo_box</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>
        <span class="n">lines_group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_lines_group</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dr3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stage</span><span class="p">(</span><span class="s2">&quot;NAS.GEN&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">],</span> <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">lines_group</span><span class="p">})</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_after</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gen&quot;</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_stage</span><span class="p">(</span>
            <span class="s2">&quot;NAS.CHR&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">],</span> <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">lines_group</span><span class="p">,</span> <span class="s2">&quot;chromo&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_chromo_group</span><span class="p">(</span><span class="n">chromo_box</span><span class="p">)},</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time taken to compute chromosphere model: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">t1</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GxBox.calc_chromo_model">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.calc_chromo_model">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calc_chromo_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="GxBox.visualize_3d_magnetic_field">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.visualize_3d_magnetic_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize_3d_magnetic_field</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launches the MagneticFieldVisualizer to visualize the 3D magnetic field data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">box_norm_direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_norm_direction</span><span class="p">()</span>
        <span class="n">box_view_up</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_view_up</span><span class="p">()</span>
        <span class="n">b3dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">b3dModelSelector</span><span class="o">.</span><span class="n">currentText</span><span class="p">()</span>
        <span class="c1"># print(f&#39;type of self.box.b3d is {type(self.box.b3d)}&#39;)</span>
        <span class="c1"># print(f&#39;value of self.box.b3d is {self.box.b3d}&#39;)</span>
        <span class="c1"># if b3dtype == &#39;pot&#39;:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">==</span> <span class="n">b3dtype</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using existing </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s2">&quot;corona&quot;</span><span class="si">}</span><span class="s1"> solution...&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">b3dtype</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">b3d</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_models</span><span class="p">[</span><span class="n">b3dtype</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">corona_type</span> <span class="o">=</span> <span class="n">b3dtype</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Using existing </span><span class="si">{</span><span class="n">b3dtype</span><span class="si">}</span><span class="s1"> solution...&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">b3dtype</span> <span class="o">==</span> <span class="s1">&#39;pot&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_potential_field</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">b3dtype</span> <span class="o">==</span> <span class="s1">&#39;nlfff&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_nlfff</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span> <span class="o">=</span> <span class="n">MagFieldViewer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_norm_direction</span><span class="o">=</span><span class="n">box_norm_direction</span><span class="p">,</span>
                                         <span class="n">box_view_up</span><span class="o">=</span><span class="n">box_view_up</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">b3dtype</span><span class="o">=</span><span class="n">b3dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visualizer</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.update_bottom_map">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.update_bottom_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_bottom_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the bottom map displayed in the UI.</span>

<span class="sd">        :param map_name: Name of the map to be updated.</span>
<span class="sd">        :type map_name: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom_im</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom_im</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="n">map_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">map_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">map_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="n">map_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span> <span class="o">=</span> <span class="n">map_bottom</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;adaptive&quot;</span><span class="p">,</span>
                                                  <span class="n">roundtrip_coords</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_dims_pix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">_dims_pix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom_im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="n">autoalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># self.update_plot()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.update_context_map">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.update_context_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_context_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">map_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the context map displayed in the UI.</span>

<span class="sd">        :param map_name: Name of the map to be updated.</span>
<span class="sd">        :type map_name: str</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context_im</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_context_im</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">map_name</span> <span class="ow">in</span> <span class="n">HMI_B_SEGMENTS</span> <span class="o">+</span> <span class="n">HMI_B_PRODUCTS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;magnetogram&#39;</span><span class="p">,</span> <span class="s1">&#39;continuum&#39;</span><span class="p">]:</span>
            <span class="n">map_context_prev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="p">[</span><span class="n">map_name</span><span class="p">]</span> <span class="k">if</span> <span class="n">map_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sdomaps</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">loadmap</span><span class="p">(</span><span class="n">map_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">map_name</span> <span class="ow">in</span> <span class="n">HMI_B_SEGMENTS</span> <span class="o">+</span> <span class="n">HMI_B_PRODUCTS</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;magnetogram&#39;</span><span class="p">,</span> <span class="s1">&#39;continuum&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">map_context_prev</span><span class="o">.</span><span class="n">wcs</span><span class="p">)</span>
        <span class="c1"># else:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context_im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


    <span class="nd">@property</span>
<div class="viewcode-block" id="GxBox.get_axes_world_coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.get_axes_world_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_axes_world_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get pixel bounds</span>
        <span class="n">pixel_coords_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span>
        <span class="n">pixel_coords_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

        <span class="c1"># Convert pixel bounds to world coordinates</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">pixel_to_world</span><span class="p">(</span><span class="n">pixel_coords_x</span><span class="p">,</span> <span class="n">pixel_coords_y</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">world_coords</span></div>


<div class="viewcode-block" id="GxBox.get_axes_pixel_coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.get_axes_pixel_coords">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_axes_pixel_coords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coords_world</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">coords_world</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">coords_world</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_world_coords</span>
        <span class="n">world_coords</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">Tx</span><span class="o">=</span><span class="n">coords_world</span><span class="o">.</span><span class="n">Tx</span><span class="p">,</span> <span class="n">Ty</span><span class="o">=</span><span class="n">coords_world</span><span class="o">.</span><span class="n">Ty</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="p">)</span>
        <span class="n">pixel_coords_x</span><span class="p">,</span> <span class="n">pixel_coords_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">world_coords</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pixel_coords_x</span><span class="p">,</span> <span class="n">pixel_coords_y</span></div>


    <span class="c1"># def toggle_cmap_clip(self):</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     Toggles the clipping of the colormap.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     if self.cmap_clip_checkbox.isChecked():</span>
    <span class="c1">#         self.bmaxClipCheckbox.setChecked(True)</span>
    <span class="c1">#         self.bminClipCheckbox.setChecked(True)</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         self.bmaxClipCheckbox.setChecked(False)</span>
    <span class="c1">#         self.bminClipCheckbox.setChecked(False)</span>

<div class="viewcode-block" id="GxBox.toggle_fieldlines_visibility">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.toggle_fieldlines_visibility">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">toggle_fieldlines_visibility</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Toggles the visibility of the fieldlines from the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Toggling fieldlines visibility: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span><span class="p">:</span>
            <span class="n">lc</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggleFieldlinesButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Hide&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toggleFieldlinesButton</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Show&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.clear_fieldlines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.clear_fieldlines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_fieldlines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears the fieldlines from the plot.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span><span class="p">:</span>
            <span class="n">lc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">lc</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>  <span class="c1"># Remove the LineCollection from the axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.update_plot">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.update_plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">show_bound_box</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_box_outline</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the plot with the current data and settings.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes_world_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_world_coords</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context_im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">draw_grid</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">draw_limb</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># for edge in self.simbox.bottom_edges:</span>
        <span class="c1">#     ax.plot_coord(edge, color=&#39;r&#39;, ls=&#39;-&#39;, marker=&#39;&#39;, lw=1.0)</span>
        <span class="c1"># for edge in self.simbox.non_bottom_edges:</span>
        <span class="c1">#     ax.plot_coord(edge, color=&#39;r&#39;, ls=&#39;--&#39;, marker=&#39;&#39;, lw=0.5)</span>
        <span class="k">if</span> <span class="n">show_box_outline</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">bottom_edges</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot_coord</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">non_bottom_edges</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot_coord</span><span class="p">(</span><span class="n">edge</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;tab:red&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="c1"># self.map_context.draw_quadrangle(self.map_bottom.bottom_left_coord, axes=ax,</span>
        <span class="c1">#                                  width=self.map_bottom.top_right_coord.lon - self.map_bottom.bottom_left_coord.lon,</span>
        <span class="c1">#                                  height=self.map_bottom.top_right_coord.lat - self.map_bottom.bottom_left_coord.lat,</span>
        <span class="c1">#                                  edgecolor=&#39;tab:red&#39;, linestyle=&#39;--&#39;, linewidth=0.5)</span>
        <span class="c1"># ax.plot_coord(self.box_center, color=&#39;r&#39;, marker=&#39;+&#39;)</span>
        <span class="c1"># ax.plot_coord(self.box_origin, mec=&#39;r&#39;, mfc=&#39;none&#39;, marker=&#39;o&#39;)</span>
        <span class="k">if</span> <span class="n">show_bound_box</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">draw_quadrangle</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">box</span><span class="o">.</span><span class="n">bounds_coords</span><span class="p">,</span>
                <span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                <span class="n">edgecolor</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom_im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_bottom</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">autoalign</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">(),</span> <span class="n">pad</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_world_coords_init</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">axes_world_coords_init</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_world_coords</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes_world_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes_pixel_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_axes_pixel_coords</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">axes_pixel_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">axes_pixel_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="c1"># Refresh canvas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.extract_streamlines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.extract_streamlines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">extract_streamlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">streamlines</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Extracts individual streamlines from the streamlines data.</span>

<span class="sd">        :param streamlines: pyvista.PolyData</span>
<span class="sd">            The streamlines data.</span>
<span class="sd">        :return: list of numpy.ndarray</span>
<span class="sd">            A list of individual streamlines.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">n_lines</span> <span class="o">=</span> <span class="n">streamlines</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n_lines</span><span class="p">:</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="n">streamlines</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="n">streamlines</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">num_points</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">streamlines</span><span class="o">.</span><span class="n">points</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">bx</span> <span class="o">=</span> <span class="n">streamlines</span><span class="p">[</span><span class="s1">&#39;bx&#39;</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">by</span> <span class="o">=</span> <span class="n">streamlines</span><span class="p">[</span><span class="s1">&#39;by&#39;</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">bz</span> <span class="o">=</span> <span class="n">streamlines</span><span class="p">[</span><span class="s1">&#39;bz&#39;</span><span class="p">][</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">]</span>
            <span class="n">magnitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">bx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">by</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">bz</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;bx&#39;</span><span class="p">:</span> <span class="n">bx</span><span class="p">,</span> <span class="s1">&#39;by&#39;</span><span class="p">:</span> <span class="n">by</span><span class="p">,</span> <span class="s1">&#39;bz&#39;</span><span class="p">:</span> <span class="n">bz</span><span class="p">,</span> <span class="s1">&#39;magnitude&#39;</span><span class="p">:</span> <span class="n">magnitude</span><span class="p">})</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="n">num_points</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">lines</span><span class="p">,</span> <span class="n">fields</span></div>


<div class="viewcode-block" id="GxBox.plot_fieldlines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.plot_fieldlines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot_fieldlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">streamlines</span><span class="p">,</span> <span class="n">z_base</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the extracted fieldlines with colorization based on their magnitude.</span>

<span class="sd">        :param streamlines: pyvista.PolyData</span>
<span class="sd">            The streamlines data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flines</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;coords_hcc&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">[],</span> <span class="s1">&#39;frame_obs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frame_obs</span><span class="p">}</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">LineCollection</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">axes</span>

        <span class="c1"># Fetch Bmin and Bmax values from input fields</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bminInput</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
            <span class="n">bmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bmaxInput</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">bmin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bmax</span> <span class="o">=</span> <span class="mi">1000</span>

        <span class="c1"># Normalize the magnitude values for colormap</span>

        <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cmapSelector</span><span class="o">.</span><span class="n">currentText</span><span class="p">())</span>
        <span class="c1"># Check if bounds input box is empty</span>
        <span class="n">bounds_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cmapDiscreteBoundsInput</span><span class="o">.</span><span class="n">text</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">bounds_text</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">bounds_text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)))</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">BoundaryNorm</span><span class="p">(</span><span class="n">bounds</span><span class="p">,</span> <span class="n">cmap</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm</span> <span class="o">=</span> <span class="n">mcolors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">bmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">bmax</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">streamlines_subset</span> <span class="ow">in</span> <span class="n">streamlines</span><span class="p">:</span>
            <span class="n">coords_hcc</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="n">coords</span><span class="p">,</span> <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_streamlines</span><span class="p">(</span><span class="n">streamlines_subset</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">coord</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
                <span class="c1"># Convert the streamline coordinates to the gxbox frame_obs</span>
                <span class="n">coord_hcc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="p">(</span><span class="n">coord</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">z_base</span><span class="p">)</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span><span class="p">,</span>
                                     <span class="n">frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_hcc</span><span class="p">)</span>
                <span class="n">coords_hcc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coord_hcc</span><span class="p">)</span>
                <span class="n">coord_hpc</span> <span class="o">=</span> <span class="n">coord_hcc</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frame_obs</span><span class="p">)</span>
                <span class="c1"># ax.plot_coord(coord_hpc, &#39;-&#39;, c=&#39;tab:blue&#39;, lw=0.3, alpha=0.5)</span>
                <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">map_context</span><span class="o">.</span><span class="n">world_to_pixel</span><span class="p">(</span><span class="n">coord_hpc</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xpix</span><span class="o">.</span><span class="n">value</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">ypix</span><span class="o">.</span><span class="n">value</span>
                <span class="n">magnitude</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;magnitude&#39;</span><span class="p">]</span>
                <span class="n">segments</span> <span class="o">=</span> <span class="p">[((</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmap</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">magnitude</span><span class="p">]</span>  <span class="c1"># Colormap for each segment</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bminClipCheckbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmaxClipCheckbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                    <span class="n">bmin</span> <span class="o">=</span> <span class="mf">0.0</span>
                    <span class="n">bmax</span> <span class="o">=</span> <span class="mf">5e6</span>  <span class="c1">## an unrealistic large B field value for solar corona</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bminClipCheckbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                        <span class="n">bmin</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bminInput</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bmaxClipCheckbox</span><span class="o">.</span><span class="n">isChecked</span><span class="p">():</span>
                        <span class="n">bmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bmaxInput</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">magnitude</span> <span class="o">&gt;=</span> <span class="n">bmin</span><span class="p">,</span> <span class="n">magnitude</span> <span class="o">&lt;=</span> <span class="n">bmax</span><span class="p">)</span>
                    <span class="n">colors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">colors</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
                    <span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">segments</span><span class="p">)[</span><span class="n">mask</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
                <span class="c1"># if self.cmap_clip_checkbox.isChecked():</span>
                <span class="c1">#     bmin = float(self.bminInput.text())</span>
                <span class="c1">#     bmax = float(self.bmaxInput.text())</span>
                <span class="c1">#     mask = np.logical_and(magnitude &gt;= bmin, magnitude &lt;= bmax)</span>
                <span class="c1">#     colors = np.array(colors)[mask]</span>
                <span class="c1">#     segments = np.array(segments)[mask[:-1]]</span>
                <span class="n">lc</span> <span class="o">=</span> <span class="n">LineCollection</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="n">colors</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LineWidthInput</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
                <span class="n">lc</span><span class="o">.</span><span class="n">set_alpha</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">LineAlphaInput</span><span class="o">.</span><span class="n">text</span><span class="p">()))</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_collection</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_line_collection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lc</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fieldlines_show_status</span><span class="p">:</span>
                    <span class="n">lc</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flines</span><span class="p">[</span><span class="s1">&#39;coords_hcc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coords_hcc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flines</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span></div>


<div class="viewcode-block" id="GxBox.save_fieldlines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.save_fieldlines">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save_fieldlines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default_filename</span><span class="o">=</span><span class="s1">&#39;fieldlines.pkl&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves the fieldlines data to a file. Prompts the user to select a directory and input a filename.</span>

<span class="sd">        :param default_filename: str</span>
<span class="sd">            The default name of the file to save the fieldlines data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open a file dialog to select directory and input filename</span>
        <span class="n">options</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span>
        <span class="n">options</span> <span class="o">|=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">DontUseNativeDialog</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">QFileDialog</span><span class="o">.</span><span class="n">getSaveFileName</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;Save Field Lines&quot;</span><span class="p">,</span> <span class="n">default_filename</span><span class="p">,</span> <span class="s2">&quot;Pickle Files (*.pkl)&quot;</span><span class="p">,</span>
                                                  <span class="n">options</span><span class="o">=</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># Save the fieldlines if a valid filename is provided</span>
        <span class="k">if</span> <span class="n">filename</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flines</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field lines saved to </span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="GxBox.plot">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.plot">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plots the data in the UI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_plot</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig</span></div>


<div class="viewcode-block" id="GxBox.create_lines_of_sight">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.create_lines_of_sight">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_lines_of_sight</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates lines of sight for the visualization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The rest of the code for creating lines of sight goes here</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="GxBox.visualize">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.GxBox.visualize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visualize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Visualizes the data in the UI.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The rest of the code for visualization goes here</span>
        <span class="k">pass</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_validate_frame</span><span class="p">(</span>
        <span class="n">hpc</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">hgc</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">hgs</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">coords</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">observation_time</span><span class="p">:</span> <span class="n">Time</span><span class="p">,</span>
        <span class="n">observer_coord</span><span class="p">:</span> <span class="n">SkyCoord</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SkyCoord</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Determine the box origin based on which frame flag is set.</span>
<span class="sd">    Exactly one of hpc, hgc, or hgs must be True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">hpc</span> <span class="o">+</span> <span class="n">hgc</span> <span class="o">+</span> <span class="n">hgs</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s2">&quot;Exactly one coordinate frame must be specified: use either --hpc, --hgc, or --hgs.&quot;</span><span class="p">)</span>

    <span class="n">rsun</span> <span class="o">=</span> <span class="mi">696</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span>  <span class="c1"># Solar radius in Mm</span>

    <span class="k">if</span> <span class="n">hpc</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
            <span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
            <span class="n">obstime</span><span class="o">=</span><span class="n">observation_time</span><span class="p">,</span>
            <span class="n">observer</span><span class="o">=</span><span class="n">observer_coord</span><span class="p">,</span>
            <span class="n">rsun</span><span class="o">=</span><span class="n">rsun</span><span class="p">,</span>
            <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;helioprojective&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">hgc</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">obstime</span><span class="o">=</span><span class="n">observation_time</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">rsun</span><span class="p">,</span>
            <span class="n">observer</span><span class="o">=</span><span class="n">observer_coord</span><span class="p">,</span>
            <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;heliographic_carrington&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># hgs</span>
        <span class="k">return</span> <span class="n">SkyCoord</span><span class="p">(</span>
            <span class="n">lon</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
            <span class="n">obstime</span><span class="o">=</span><span class="n">observation_time</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="n">rsun</span><span class="p">,</span>
            <span class="n">observer</span><span class="o">=</span><span class="n">observer_coord</span><span class="p">,</span>
            <span class="n">frame</span><span class="o">=</span><span class="s2">&quot;heliographic_stonyhurst&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gxbox_factory/index.html#pyampp.gxbox.gxbox_factory.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
        <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;--time&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Observation time in ISO format, e.g., &quot;2024-05-12T00:00:00&quot;.&#39;</span>
        <span class="p">),</span>
        <span class="n">coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;--coords&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Two floats: [x, y] (arcsec if HPC, degrees if HGC or HGS). Example: 0.0 0.0&quot;</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">hpc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--hpc&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use Helioprojective coordinates.&quot;</span>
        <span class="p">),</span>
        <span class="n">hgc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--hgc&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use Heliographic Carrington coordinates.&quot;</span>
        <span class="p">),</span>
        <span class="n">hgs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--hgs&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use Heliographic Stonyhurst coordinates.&quot;</span>
        <span class="p">),</span>
        <span class="n">box_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
            <span class="s2">&quot;--box-dims&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Three ints: box dimensions [nx, ny, nz] in pixels. Example: 100 100 100&quot;</span>
        <span class="p">),</span>
        <span class="n">box_res</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="mf">1.4</span><span class="p">,</span>
            <span class="s2">&quot;--box-res&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Box resolution in Mm per pixel.&quot;</span>
        <span class="p">),</span>
        <span class="n">observer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="s2">&quot;Earth&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--observer&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Observer location (e.g., &#39;earth&#39; or a named object).&quot;</span>
        <span class="p">),</span>
        <span class="n">pad_frac</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="mf">0.25</span><span class="p">,</span>
            <span class="s2">&quot;--pad-frac&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Fractional padding applied to each side of the box (decimal).&quot;</span>
        <span class="p">),</span>
        <span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="n">DOWNLOAD_DIR</span><span class="p">,</span>
            <span class="s2">&quot;--data-dir&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for storing downloaded data.&quot;</span>
        <span class="p">),</span>
        <span class="n">gxmodel_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="n">GXMODEL_DIR</span><span class="p">,</span>
            <span class="s2">&quot;--gxmodel-dir&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for storing model outputs.&quot;</span>
        <span class="p">),</span>
        <span class="n">external_box</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()),</span>
            <span class="s2">&quot;--external-box&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to an external box file.&quot;</span>
        <span class="p">),</span>
        <span class="n">interactive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--interactive&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Enable interactive mode (drops into pdb after launching).&quot;</span>
        <span class="p">),</span>
        <span class="n">euv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;--euv/--no-euv&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Download AIA/EUV context maps (default: on).&quot;</span>
        <span class="p">),</span>
        <span class="n">uv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;--uv/--no-uv&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Download AIA/UV context maps (default: on).&quot;</span>
        <span class="p">),</span>
        <span class="n">hmifiles</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;--hmifiles&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a local HMI data directory to bypass downloads.&quot;</span>
        <span class="p">),</span>
        <span class="n">entry_box</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;--entry-box&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to a preexisting box to use as starting point.&quot;</span>
        <span class="p">),</span>
        <span class="n">empty_box_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--empty-box-only&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after empty box is generated.&quot;</span>
        <span class="p">),</span>
        <span class="n">potential_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--potential-only&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Compute only the potential extrapolation and stop.&quot;</span>
        <span class="p">),</span>
        <span class="n">use_potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--use-potential&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip NLFFF and use the potential field for downstream steps.&quot;</span>
        <span class="p">),</span>
        <span class="n">jump2potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--jump2potential&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start from entry_box and jump to potential stage.&quot;</span>
        <span class="p">),</span>
        <span class="n">jump2nlfff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--jump2nlfff&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start from entry_box and jump to NLFFF stage.&quot;</span>
        <span class="p">),</span>
        <span class="n">jump2lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--jump2lines&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start from entry_box and jump to lines/GEN stage.&quot;</span>
        <span class="p">),</span>
        <span class="n">jump2chromo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--jump2chromo&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start from entry_box and jump to chromo stage.&quot;</span>
        <span class="p">),</span>
        <span class="n">save_empty_box</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--save-empty-box&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the empty box stage (NONE).&quot;</span>
        <span class="p">),</span>
        <span class="n">save_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--save-bounds&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the boundary stage (BND).&quot;</span>
        <span class="p">),</span>
        <span class="n">save_potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--save-potential&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the potential stage (POT).&quot;</span>
        <span class="p">),</span>
        <span class="n">save_nas</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--save-nas&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the NLFFF stage (NAS).&quot;</span>
        <span class="p">),</span>
        <span class="n">save_gen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--save-gen&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the GEN stage (NAS.GEN).&quot;</span>
        <span class="p">),</span>
        <span class="n">save_chr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--save-chr&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save the CHR stage (NAS.CHR).&quot;</span>
        <span class="p">),</span>
        <span class="n">stop_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="s2">&quot;--stop-after&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after stage: pot|nas|gen|chr.&quot;</span>
        <span class="p">),</span>
        <span class="n">auto_visualize_last</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;--auto-visualize-last/--no-auto-visualize-last&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Auto-launch the 3D viewer for the last stage.&quot;</span>
        <span class="p">),</span>
        <span class="n">info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;--info&quot;</span><span class="p">,</span>
            <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Print all explicit and implicit options with their meanings and exit.&quot;</span>
        <span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Launch the GxBox application with the specified parameters.</span>

<span class="sd">    :param time: Observation time in ISO format (e.g., &quot;2024-05-12T00:00:00&quot;).</span>
<span class="sd">    :type time: str</span>
<span class="sd">    :param coords: Two floats representing [x, y] (arcsec if HPC, degrees if HGC or HGS). Example: 0.0 0.0</span>
<span class="sd">    :type coords: Tuple[float, float]</span>
<span class="sd">    :param hpc: Use Helioprojective coordinates, defaults to False</span>
<span class="sd">    :type hpc: bool, optional</span>
<span class="sd">    :param hgc: Use Heliographic Carrington coordinates, defaults to False</span>
<span class="sd">    :type hgc: bool, optional</span>
<span class="sd">    :param hgs: Use Heliographic Stonyhurst coordinates, defaults to False</span>
<span class="sd">    :type hgs: bool, optional</span>
<span class="sd">    :param box_dims: Three integers [nx, ny, nz] specifying box dimensions in pixels. Example: 100 100 100</span>
<span class="sd">                     Defaults to (100, 100, 100).</span>
<span class="sd">    :type box_dims: Tuple[int, int, int], optional</span>
<span class="sd">    :param box_res: Box resolution in Mm per pixel, defaults to 1.4</span>
<span class="sd">    :type box_res: float, optional</span>
<span class="sd">    :param observer: Observer location (e.g., &#39;Earth&#39; or a named object), defaults to &quot;Earth&quot;</span>
<span class="sd">    :type observer: str, optional</span>
<span class="sd">    :param pad_frac: Fractional padding applied to each side of the box (decimal), defaults to 0.25</span>
<span class="sd">    :type pad_frac: float, optional</span>
<span class="sd">    :param data_dir: Directory for storing downloaded data, defaults to DOWNLOAD_DIR</span>
<span class="sd">    :type data_dir: str, optional</span>
<span class="sd">    :param gxmodel_dir: Directory for storing model outputs, defaults to GXMODEL_DIR</span>
<span class="sd">    :type gxmodel_dir: str, optional</span>
<span class="sd">    :param external_box: Path to an external box file, defaults to current working directory</span>
<span class="sd">    :type external_box: str, optional</span>
<span class="sd">    :param interactive: Enable interactive mode (drops into pdb after launching), defaults to False</span>
<span class="sd">    :type interactive: bool, optional</span>
<span class="sd">    :raises typer.BadParameter: If none or multiple coordinate frame flags (--hpc, --hgc, --hgs) are provided</span>
<span class="sd">    :return: None</span>
<span class="sd">    :rtype: NoneType</span>

<span class="sd">    Example:</span>
<span class="sd">    --------</span>
<span class="sd">    .. code-block:: bash</span>

<span class="sd">      gxbox \</span>
<span class="sd">        --time &quot;2022-03-30T17:22:37&quot; \</span>
<span class="sd">        --coords 34.44988566346035 14.26110705696788 \</span>
<span class="sd">        --hgs \</span>
<span class="sd">        --box-dims 360 180 200 \</span>
<span class="sd">        --box-res 0.729 \</span>
<span class="sd">        --pad-frac 0.25 \</span>
<span class="sd">        --data-dir /path/to/download_dir \</span>
<span class="sd">        --gxmodel-dir /path/to/gx_models_dir</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_execute_cmd</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;gxbox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--time&quot;</span><span class="p">,</span>
            <span class="n">time</span> <span class="ow">or</span> <span class="s2">&quot;&lt;MISSING_TIME&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--coords&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">coords</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_X&gt;&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">coords</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_Y&gt;&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">hpc</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--hpc&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hgc</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--hgc&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">hgs</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--hgs&quot;</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="s2">&quot;--box-dims&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">box_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="n">box_dims</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_NX&gt;&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">box_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">if</span> <span class="n">box_dims</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_NY&gt;&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">box_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="k">if</span> <span class="n">box_dims</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_NZ&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--box-res&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">box_res</span><span class="p">)</span> <span class="k">if</span> <span class="n">box_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_BOX_RES&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--pad-frac&quot;</span><span class="p">,</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">pad_frac</span><span class="p">)</span> <span class="k">if</span> <span class="n">pad_frac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_PAD_FRAC&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--data-dir&quot;</span><span class="p">,</span>
            <span class="n">data_dir</span> <span class="ow">or</span> <span class="s2">&quot;&lt;MISSING_DATA_DIR&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--gxmodel-dir&quot;</span><span class="p">,</span>
            <span class="n">gxmodel_dir</span> <span class="ow">or</span> <span class="s2">&quot;&lt;MISSING_GXMODEL_DIR&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--observer&quot;</span><span class="p">,</span>
            <span class="n">observer</span> <span class="ow">or</span> <span class="s2">&quot;&lt;MISSING_OBSERVER&gt;&quot;</span><span class="p">,</span>
            <span class="s2">&quot;--external-box&quot;</span><span class="p">,</span>
            <span class="n">external_box</span> <span class="ow">or</span> <span class="s2">&quot;&lt;MISSING_EXTERNAL_BOX&gt;&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--interactive&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">euv</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-euv&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uv</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-uv&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmifiles</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--hmifiles&quot;</span><span class="p">,</span> <span class="n">hmifiles</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">entry_box</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--entry-box&quot;</span><span class="p">,</span> <span class="n">entry_box</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">empty_box_only</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--empty-box-only&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">potential_only</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--potential-only&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">use_potential</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--use-potential&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jump2potential</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2potential&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jump2nlfff</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2nlfff&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jump2lines</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2lines&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jump2chromo</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2chromo&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_empty_box</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-empty-box&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_bounds</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-bounds&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_potential</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-potential&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_nas</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-nas&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_gen</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-gen&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">save_chr</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-chr&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stop_after</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--stop-after&quot;</span><span class="p">,</span> <span class="n">stop_after</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">auto_visualize_last</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--no-auto-visualize-last&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_print_info</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gxbox options (explicit and implicit):&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">time_val</span> <span class="o">=</span> <span class="n">time</span> <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING&gt; (required)&quot;</span>
        <span class="n">coords_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING&gt; (required)&quot;</span>
        <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;--hpc&quot;</span> <span class="k">if</span> <span class="n">hpc</span> <span class="k">else</span> <span class="s2">&quot;--hgc&quot;</span> <span class="k">if</span> <span class="n">hgc</span> <span class="k">else</span> <span class="s2">&quot;--hgs&quot;</span> <span class="k">if</span> <span class="n">hgs</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING_FRAME&gt;&quot;</span>
        <span class="n">box_dims_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">box_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">box_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">box_dims</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">box_dims</span> <span class="k">else</span> <span class="s2">&quot;&lt;MISSING&gt;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --time           Observation time in ISO format. [value: </span><span class="si">{</span><span class="n">time_val</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --coords         Center coordinates. [value: </span><span class="si">{</span><span class="n">coords_val</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">frame</span><span class="si">:</span><span class="s2">&lt;15</span><span class="si">}</span><span class="s2"> Coordinate frame flag (exactly one of --hpc/--hgc/--hgs).&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --box-dims       Box dimensions [nx ny nz] in pixels. [value: </span><span class="si">{</span><span class="n">box_dims_val</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --box-res        Box resolution in Mm per pixel. [value: </span><span class="si">{</span><span class="n">box_res</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --pad-frac       Fractional padding applied to each side. [value: </span><span class="si">{</span><span class="n">pad_frac</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --observer       Observer location. [value: </span><span class="si">{</span><span class="n">observer</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --data-dir       Directory for downloaded data. [value: </span><span class="si">{</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --gxmodel-dir    Directory for model outputs. [value: </span><span class="si">{</span><span class="n">gxmodel_dir</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --external-box   Path to an external box file. [value: </span><span class="si">{</span><span class="n">external_box</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --interactive    Drop into pdb after launching. [value: </span><span class="si">{</span><span class="n">interactive</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --euv            Download AIA/EUV context maps. [value: </span><span class="si">{</span><span class="n">euv</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --uv             Download AIA/UV context maps. [value: </span><span class="si">{</span><span class="n">uv</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --hmifiles       Local HMI data directory. [value: </span><span class="si">{</span><span class="n">hmifiles</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --entry-box      Preexisting box path. [value: </span><span class="si">{</span><span class="n">entry_box</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --empty-box-only Stop after empty box is generated. [value: </span><span class="si">{</span><span class="n">empty_box_only</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --potential-only Stop after potential extrapolation. [value: </span><span class="si">{</span><span class="n">potential_only</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --use-potential  Skip NLFFF and use potential downstream. [value: </span><span class="si">{</span><span class="n">use_potential</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --jump2potential Jump to potential stage (requires --entry-box). [value: </span><span class="si">{</span><span class="n">jump2potential</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --jump2nlfff     Jump to NLFFF stage (requires --entry-box). [value: </span><span class="si">{</span><span class="n">jump2nlfff</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --jump2lines     Jump to GEN stage (requires --entry-box). [value: </span><span class="si">{</span><span class="n">jump2lines</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --jump2chromo    Jump to chromo stage (requires --entry-box). [value: </span><span class="si">{</span><span class="n">jump2chromo</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --save-empty-box Save NONE stage. [value: </span><span class="si">{</span><span class="n">save_empty_box</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --save-bounds    Save BND stage. [value: </span><span class="si">{</span><span class="n">save_bounds</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --save-potential Save POT stage. [value: </span><span class="si">{</span><span class="n">save_potential</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --save-nas       Save NAS stage. [value: </span><span class="si">{</span><span class="n">save_nas</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --save-gen       Save NAS.GEN stage. [value: </span><span class="si">{</span><span class="n">save_gen</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --save-chr       Save NAS.CHR stage. [value: </span><span class="si">{</span><span class="n">save_chr</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --stop-after     Stop after stage (pot|nas|gen|chr). [value: </span><span class="si">{</span><span class="n">stop_after</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  --auto-visualize-last Auto-launch 3D viewer for last stage. [value: </span><span class="si">{</span><span class="n">auto_visualize_last</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Implicit behaviors:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - Exactly one coordinate frame flag must be set (--hpc/--hgc/--hgs).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - WARNING: --time is required for actual execution.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - WARNING: --coords is required for actual execution.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">hpc</span> <span class="ow">or</span> <span class="n">hgc</span> <span class="ow">or</span> <span class="n">hgs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - WARNING: one of --hpc/--hgc/--hgs is required for actual execution.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">jump2potential</span> <span class="ow">or</span> <span class="n">jump2nlfff</span> <span class="ow">or</span> <span class="n">jump2lines</span> <span class="ow">or</span> <span class="n">jump2chromo</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">entry_box</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - WARNING: jump2* flags are ignored unless --entry-box is provided.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - The gxbox GUI launches unless --info is used.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - The last stage is always saved; additional stages depend on save flags.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - The full gxbox command is recorded into HDF5 metadata/execute.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">info</span><span class="p">:</span>
        <span class="n">_print_info</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s2">&quot;--time is required unless --info is used.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s2">&quot;--coords is required unless --info is used.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">hpc</span> <span class="ow">or</span> <span class="n">hgc</span> <span class="ow">or</span> <span class="n">hgs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">typer</span><span class="o">.</span><span class="n">BadParameter</span><span class="p">(</span><span class="s2">&quot;Exactly one coordinate frame must be specified: use either --hpc, --hgc, or --hgs.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">empty_box_only</span><span class="p">:</span>
        <span class="n">save_empty_box</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">stop_after</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
    <span class="k">if</span> <span class="n">potential_only</span><span class="p">:</span>
        <span class="n">save_potential</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">stop_after</span> <span class="o">=</span> <span class="s2">&quot;pot&quot;</span>

    <span class="n">observation_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>

    <span class="c1"># Determine observer location</span>
    <span class="n">observer_coord</span> <span class="o">=</span> <span class="n">get_earth</span><span class="p">(</span><span class="n">observation_time</span><span class="p">)</span> <span class="k">if</span> <span class="n">observer</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;earth&quot;</span> <span class="k">else</span> <span class="n">SkyCoord</span><span class="o">.</span><span class="n">from_name</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>

    <span class="c1"># Validate and compute box origin</span>
    <span class="n">box_origin</span> <span class="o">=</span> <span class="n">_validate_frame</span><span class="p">(</span><span class="n">hpc</span><span class="p">,</span> <span class="n">hgc</span><span class="p">,</span> <span class="n">hgs</span><span class="p">,</span> <span class="n">coords</span><span class="p">,</span> <span class="n">observation_time</span><span class="p">,</span> <span class="n">observer_coord</span><span class="p">)</span>

    <span class="c1"># Convert box dimensions and resolution to astropy Quantities</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">box_dims</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
    <span class="n">resolution</span> <span class="o">=</span> <span class="n">box_res</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">Mm</span>

    <span class="c1"># Instantiate Qt application and GxBox</span>
    <span class="n">app_instance</span> <span class="o">=</span> <span class="n">QApplication</span><span class="p">([])</span>
    <span class="n">execute_cmd</span> <span class="o">=</span> <span class="n">_build_execute_cmd</span><span class="p">()</span>
    <span class="n">gxbox</span> <span class="o">=</span> <span class="n">GxBox</span><span class="p">(</span>
        <span class="n">observation_time</span><span class="p">,</span>
        <span class="n">observer_coord</span><span class="p">,</span>
        <span class="n">box_origin</span><span class="p">,</span>
        <span class="n">dims</span><span class="p">,</span>
        <span class="n">resolution</span><span class="p">,</span>
        <span class="n">pad_frac</span><span class="o">=</span><span class="n">pad_frac</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="n">gxmodel_dir</span><span class="o">=</span><span class="n">gxmodel_dir</span><span class="p">,</span>
        <span class="n">external_box</span><span class="o">=</span><span class="n">external_box</span><span class="p">,</span>
        <span class="n">execute_cmd</span><span class="o">=</span><span class="n">execute_cmd</span><span class="p">,</span>
        <span class="n">euv</span><span class="o">=</span><span class="n">euv</span><span class="p">,</span>
        <span class="n">uv</span><span class="o">=</span><span class="n">uv</span><span class="p">,</span>
        <span class="n">hmifiles</span><span class="o">=</span><span class="n">hmifiles</span><span class="p">,</span>
        <span class="n">entry_box</span><span class="o">=</span><span class="n">entry_box</span><span class="p">,</span>
        <span class="n">empty_box_only</span><span class="o">=</span><span class="n">empty_box_only</span><span class="p">,</span>
        <span class="n">potential_only</span><span class="o">=</span><span class="n">potential_only</span><span class="p">,</span>
        <span class="n">use_potential</span><span class="o">=</span><span class="n">use_potential</span><span class="p">,</span>
        <span class="n">jump2potential</span><span class="o">=</span><span class="n">jump2potential</span><span class="p">,</span>
        <span class="n">jump2nlfff</span><span class="o">=</span><span class="n">jump2nlfff</span><span class="p">,</span>
        <span class="n">jump2lines</span><span class="o">=</span><span class="n">jump2lines</span><span class="p">,</span>
        <span class="n">jump2chromo</span><span class="o">=</span><span class="n">jump2chromo</span><span class="p">,</span>
        <span class="n">save_empty_box</span><span class="o">=</span><span class="n">save_empty_box</span><span class="p">,</span>
        <span class="n">save_bounds</span><span class="o">=</span><span class="n">save_bounds</span><span class="p">,</span>
        <span class="n">save_potential</span><span class="o">=</span><span class="n">save_potential</span><span class="p">,</span>
        <span class="n">save_nas</span><span class="o">=</span><span class="n">save_nas</span><span class="p">,</span>
        <span class="n">save_gen</span><span class="o">=</span><span class="n">save_gen</span><span class="p">,</span>
        <span class="n">save_chr</span><span class="o">=</span><span class="n">save_chr</span><span class="p">,</span>
        <span class="n">stop_after</span><span class="o">=</span><span class="n">stop_after</span><span class="p">,</span>
        <span class="n">auto_visualize_last</span><span class="o">=</span><span class="n">auto_visualize_last</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">gxbox</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">interactive</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pdb</span>

        <span class="n">pdb</span><span class="o">.</span><span class="n">set_trace</span><span class="p">()</span>

    <span class="n">app_instance</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, suncast-org.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>