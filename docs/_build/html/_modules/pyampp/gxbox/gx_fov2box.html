

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyampp.gxbox.gx_fov2box &mdash; pyAMPP 0.2.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=4ae1632d" />

  
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=938c9ccc"></script>
      <script src="../../../_static/doctools.js?v=fd6eb6e6"></script>
      <script src="../../../_static/sphinx_highlight.js?v=6ffebe34"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            pyAMPP
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../model_hdf5_format.html">pyAMPP HDF5 Model Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gui_workflow.html">pyAMPP GUI Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../viewers.html">Model Viewers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html#id1">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyAMPP</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">pyampp.gxbox.gx_fov2box</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyampp.gxbox.gx_fov2box</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">shlex</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">re</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">ast</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">io</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">astropy.units</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">u</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="n">SkyCoord</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.time</span><span class="w"> </span><span class="kn">import</span> <span class="n">Time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyAMaFiL.mag_field_lin_fff</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagFieldLinFFF</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyAMaFiL.mag_field_proc</span><span class="w"> </span><span class="kn">import</span> <span class="n">MagFieldProcessor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">readsav</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sunpy.coordinates</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">Heliocentric</span><span class="p">,</span> <span class="n">HeliographicCarrington</span><span class="p">,</span> <span class="n">HeliographicStonyhurst</span><span class="p">,</span>
                               <span class="n">Helioprojective</span><span class="p">,</span> <span class="n">get_earth</span><span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sunpy.map</span><span class="w"> </span><span class="kn">import</span> <span class="n">Map</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sunpy.sun</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="k">as</span> <span class="n">sun_consts</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.data.downloader</span><span class="w"> </span><span class="kn">import</span> <span class="n">SDOImageDownloader</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gx_chromo.combo_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">combo_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gx_chromo.decompose</span><span class="w"> </span><span class="kn">import</span> <span class="n">decompose</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.box</span><span class="w"> </span><span class="kn">import</span> <span class="n">Box</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.boxutils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">hmi_b2ptr</span><span class="p">,</span>
    <span class="n">hmi_disambig</span><span class="p">,</span>
    <span class="n">read_b3d_h5</span><span class="p">,</span>
    <span class="n">write_b3d_h5</span><span class="p">,</span>
    <span class="n">compute_vertical_current</span><span class="p">,</span>
    <span class="n">load_sunpy_map_compat</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.gxbox.gx_box2id</span><span class="w"> </span><span class="kn">import</span> <span class="n">gx_box2id</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pyampp.util.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">DOWNLOAD_DIR</span><span class="p">,</span> <span class="n">GXMODEL_DIR</span><span class="p">,</span> <span class="n">AIA_EUV_PASSBANDS</span><span class="p">,</span> <span class="n">AIA_UV_PASSBANDS</span>


<div class="viewcode-block" id="app">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.app">[docs]</a>
<span class="n">app</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Typer</span><span class="p">(</span><span class="n">help</span><span class="o">=</span><span class="s2">&quot;Run gx_fov2box pipeline without GUI and save model stages.&quot;</span><span class="p">)</span></div>



<span class="nd">@dataclass</span>
<div class="viewcode-block" id="Fov2BoxConfig">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Fov2BoxConfig</span><span class="p">:</span>
<div class="viewcode-block" id="Fov2BoxConfig.time">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.time">[docs]</a>
    <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.coords">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.coords">[docs]</a>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.hpc">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.hpc">[docs]</a>
    <span class="n">hpc</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.hgc">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.hgc">[docs]</a>
    <span class="n">hgc</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.hgs">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.hgs">[docs]</a>
    <span class="n">hgs</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.cea">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.cea">[docs]</a>
    <span class="n">cea</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.top">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.top">[docs]</a>
    <span class="n">top</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.box_dims">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.box_dims">[docs]</a>
    <span class="n">box_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.dx_km">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.dx_km">[docs]</a>
    <span class="n">dx_km</span><span class="p">:</span> <span class="nb">float</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.pad_frac">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.pad_frac">[docs]</a>
    <span class="n">pad_frac</span><span class="p">:</span> <span class="nb">float</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.data_dir">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.data_dir">[docs]</a>
    <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.gxmodel_dir">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.gxmodel_dir">[docs]</a>
    <span class="n">gxmodel_dir</span><span class="p">:</span> <span class="nb">str</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.entry_box">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.entry_box">[docs]</a>
    <span class="n">entry_box</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.save_empty_box">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.save_empty_box">[docs]</a>
    <span class="n">save_empty_box</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.save_potential">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.save_potential">[docs]</a>
    <span class="n">save_potential</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.save_bounds">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.save_bounds">[docs]</a>
    <span class="n">save_bounds</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.save_nas">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.save_nas">[docs]</a>
    <span class="n">save_nas</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.save_gen">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.save_gen">[docs]</a>
    <span class="n">save_gen</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.save_chr">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.save_chr">[docs]</a>
    <span class="n">save_chr</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.stop_after">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.stop_after">[docs]</a>
    <span class="n">stop_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.empty_box_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.empty_box_only">[docs]</a>
    <span class="n">empty_box_only</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.potential_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.potential_only">[docs]</a>
    <span class="n">potential_only</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.nlfff_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.nlfff_only">[docs]</a>
    <span class="n">nlfff_only</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.generic_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.generic_only">[docs]</a>
    <span class="n">generic_only</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.use_potential">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.use_potential">[docs]</a>
    <span class="n">use_potential</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.skip_lines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.skip_lines">[docs]</a>
    <span class="n">skip_lines</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.center_vox">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.center_vox">[docs]</a>
    <span class="n">center_vox</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.reduce_passed">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.reduce_passed">[docs]</a>
    <span class="n">reduce_passed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.euv">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.euv">[docs]</a>
    <span class="n">euv</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.uv">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.uv">[docs]</a>
    <span class="n">uv</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.sfq">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.sfq">[docs]</a>
    <span class="n">sfq</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.jump2potential">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.jump2potential">[docs]</a>
    <span class="n">jump2potential</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.jump2bounds">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.jump2bounds">[docs]</a>
    <span class="n">jump2bounds</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.jump2nlfff">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.jump2nlfff">[docs]</a>
    <span class="n">jump2nlfff</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.jump2lines">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.jump2lines">[docs]</a>
    <span class="n">jump2lines</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.jump2chromo">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.jump2chromo">[docs]</a>
    <span class="n">jump2chromo</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.rebuild">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.rebuild">[docs]</a>
    <span class="n">rebuild</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.rebuild_from_none">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.rebuild_from_none">[docs]</a>
    <span class="n">rebuild_from_none</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.clone_only">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.clone_only">[docs]</a>
    <span class="n">clone_only</span><span class="p">:</span> <span class="nb">bool</span></div>

<div class="viewcode-block" id="Fov2BoxConfig.info">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.Fov2BoxConfig.info">[docs]</a>
    <span class="n">info</span><span class="p">:</span> <span class="nb">bool</span></div>
</div>



<span class="k">def</span><span class="w"> </span><span class="nf">_infer_time_from_path</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="n">stem</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">name</span>
    <span class="k">if</span> <span class="s2">&quot;hmi.M_720s.&quot;</span> <span class="ow">in</span> <span class="n">stem</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">stem</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;hmi.M_720s.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="o">==</span> <span class="mi">15</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">T</span><span class="si">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">13</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">tag</span><span class="p">[</span><span class="mi">13</span><span class="p">:</span><span class="mi">15</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
    <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_format_coord_tag</span><span class="p">(</span><span class="n">lon_deg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lat_deg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CR&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_deg</span> <span class="o">+</span> <span class="mf">180.0</span><span class="p">)</span> <span class="o">%</span> <span class="mf">360.0</span> <span class="o">-</span> <span class="mf">180.0</span>
    <span class="n">lon_dir</span> <span class="o">=</span> <span class="s2">&quot;W&quot;</span> <span class="k">if</span> <span class="n">lon</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;E&quot;</span>
    <span class="n">lat_dir</span> <span class="o">=</span> <span class="s2">&quot;N&quot;</span> <span class="k">if</span> <span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;S&quot;</span>
    <span class="n">lon_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lon</span><span class="p">)))</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">lat_val</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">abs</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">lat_deg</span><span class="p">)))</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lon_dir</span><span class="si">}{</span><span class="n">lon_val</span><span class="si">}{</span><span class="n">lat_dir</span><span class="si">}{</span><span class="n">lat_val</span><span class="si">}{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_stage_output_dir</span><span class="p">(</span><span class="n">gxmodel_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obs_time</span><span class="p">:</span> <span class="n">Time</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="n">date_str</span> <span class="o">=</span> <span class="n">obs_time</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">gxmodel_dir</span><span class="p">)</span> <span class="o">/</span> <span class="n">date_str</span>
    <span class="n">out_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_dir</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_stage_file_base</span><span class="p">(</span><span class="n">obs_time</span><span class="p">:</span> <span class="n">Time</span><span class="p">,</span> <span class="n">coord_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">projection_tag</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;CEA&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">time_tag</span> <span class="o">=</span> <span class="n">obs_time</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">_%H%M%S&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;hmi.M_720s.</span><span class="si">{</span><span class="n">time_tag</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">coord_tag</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">projection_tag</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_stage_filename</span><span class="p">(</span><span class="n">out_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">base</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Path</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">stage_tag</span><span class="si">}</span><span class="s2">.h5&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_last_stage_tag</span><span class="p">(</span><span class="n">stop_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">stop_after</span><span class="p">:</span>
        <span class="n">stop</span> <span class="o">=</span> <span class="n">stop_after</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dl&quot;</span><span class="p">,</span> <span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="s2">&quot;downloads&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;DL&quot;</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="s2">&quot;empty_box&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bnd&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;pot&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;nas&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;gen&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">==</span> <span class="s2">&quot;chr&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_canon_stage_name</span><span class="p">(</span><span class="n">tag</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tag</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;dl&quot;</span><span class="p">,</span> <span class="s2">&quot;download&quot;</span><span class="p">,</span> <span class="s2">&quot;downloads&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;DL&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="s2">&quot;empty_box&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pot&quot;</span><span class="p">,</span> <span class="s2">&quot;potential&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bnd&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nas&quot;</span><span class="p">,</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gen&quot;</span><span class="p">,</span> <span class="s2">&quot;nas.gen&quot;</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;chr&quot;</span><span class="p">,</span> <span class="s2">&quot;nas.chr&quot;</span><span class="p">,</span> <span class="s2">&quot;chromo&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_entry_stage_from_loaded</span><span class="p">(</span><span class="n">loaded</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">entry_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="c1"># Prefer explicit metadata id/model_type when present.</span>
    <span class="n">model_id</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;.POT.GEN.CHR&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.GEN.CHR&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.POT.CHR&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.POT.GEN&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.CHR&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.GEN&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.POT&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.BND&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NONE&quot;</span> <span class="ow">in</span> <span class="n">model_id</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;chromo&quot;</span> <span class="ow">in</span> <span class="n">loaded</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;lines&quot;</span> <span class="ow">in</span> <span class="n">loaded</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="n">loaded</span><span class="p">:</span>
        <span class="n">model_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">loaded</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,):</span>
            <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pot&quot;</span><span class="p">,):</span>
            <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bnd&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;nlfff&quot;</span><span class="p">,):</span>
            <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>

    <span class="c1"># Fallback from filename.</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">if</span> <span class="s2">&quot;.POT.GEN.CHR&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.GEN.CHR&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.POT.CHR&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.POT.GEN&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.CHR&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.GEN&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NAS.&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.POT&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.BND&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;.NONE&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_detect_target_stage</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Fov2BoxConfig</span><span class="p">,</span> <span class="n">entry_stage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2potential</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;POT&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2bounds</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;BND&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2nlfff</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;NAS&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2lines</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;GEN&quot;</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2chromo</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;CHR&quot;</span>
    <span class="k">if</span> <span class="n">entry_stage</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">entry_stage</span>
    <span class="k">return</span> <span class="s2">&quot;NONE&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_jump_allowed</span><span class="p">(</span><span class="n">entry_stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NONE&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;CHR&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">entry_stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order</span> <span class="ow">or</span> <span class="n">target_stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">order</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">entry_stage</span><span class="p">]</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">order</span><span class="p">[</span><span class="n">target_stage</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># same stage or backward jump</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># forward by one stage</span>
    <span class="k">if</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span> <span class="ow">and</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># convenience shortcut; POT is computed implicitly</span>
    <span class="k">if</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span> <span class="ow">and</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># implicit POT-&gt;BND-&gt;NAS transition</span>
    <span class="k">if</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span> <span class="ow">and</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># explicit pipeline exception</span>
    <span class="k">if</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span> <span class="ow">and</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;CHR&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># allow direct POT-&gt;CHR (no lines group)</span>
    <span class="k">if</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span> <span class="ow">and</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;CHR&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># allow direct NAS-&gt;CHR (no lines group)</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_warn_impossible_save_requests</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Fov2BoxConfig</span><span class="p">,</span> <span class="n">start_stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">order</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NONE&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;CHR&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">start_ord</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">start_stage</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_empty_box</span><span class="p">,</span> <span class="s2">&quot;--save-empty-box&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;BND&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_bounds</span><span class="p">,</span> <span class="s2">&quot;--save-bounds&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;POT&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_potential</span><span class="p">,</span> <span class="s2">&quot;--save-potential&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;NAS&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_nas</span><span class="p">,</span> <span class="s2">&quot;--save-nas&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;GEN&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_gen</span><span class="p">,</span> <span class="s2">&quot;--save-gen&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;CHR&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_chr</span><span class="p">,</span> <span class="s2">&quot;--save-chr&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">impossible</span> <span class="o">=</span> <span class="p">[</span><span class="n">flag</span> <span class="k">for</span> <span class="n">st</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">flag</span> <span class="ow">in</span> <span class="n">req</span> <span class="k">if</span> <span class="n">enabled</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">start_ord</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">impossible</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Warning: impossible save request(s) before selected start stage &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_stage</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">impossible</span><span class="p">)</span><span class="si">}</span><span class="s2"> (ignored).&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_stage_tag_from_stage</span><span class="p">(</span><span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;NONE&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;POT&quot;</span><span class="p">:</span> <span class="s2">&quot;POT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BND&quot;</span><span class="p">:</span> <span class="s2">&quot;BND&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NAS&quot;</span><span class="p">:</span> <span class="s2">&quot;NAS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;GEN&quot;</span><span class="p">:</span> <span class="s2">&quot;NAS.GEN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;CHR&quot;</span><span class="p">:</span> <span class="s2">&quot;NAS.CHR&quot;</span><span class="p">,</span>
    <span class="p">}</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage</span><span class="p">,</span> <span class="s2">&quot;NAS.CHR&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_execute_paths</span><span class="p">(</span><span class="n">execute_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract data/model directory defaults from metadata/execute.</span>
<span class="sd">    Supports both Python CLI form and IDL gx_fov2box form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">execute_text</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gxmodel_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">execute_text</span><span class="p">)</span>

    <span class="c1"># Python CLI style: gx-fov2box ... --data-dir X --gxmodel-dir Y</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--data-dir&quot;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--data-dir=&quot;</span><span class="p">):</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--gxmodel-dir&quot;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="n">gxmodel_dir</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--gxmodel-dir=&quot;</span><span class="p">):</span>
            <span class="n">gxmodel_dir</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># IDL style fallback: TMP_DIR=&#39;...&#39; and OUT_DIR=&#39;...&#39;</span>
    <span class="k">if</span> <span class="n">data_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bTMP_DIR\s*=\s*[&#39;</span><span class="se">\&quot;</span><span class="s2">]([^&#39;</span><span class="se">\&quot;</span><span class="s2">]+)[&#39;</span><span class="se">\&quot;</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bTMP_DIR\s*=\s*([^,\s]+)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">data_dir</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">gxmodel_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bOUT_DIR\s*=\s*[&#39;</span><span class="se">\&quot;</span><span class="s2">]([^&#39;</span><span class="se">\&quot;</span><span class="s2">]+)[&#39;</span><span class="se">\&quot;</span><span class="s2">]&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\bOUT_DIR\s*=\s*([^,\s]+)&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">gxmodel_dir</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">data_dir</span><span class="p">,</span> <span class="n">gxmodel_dir</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_extract_execute_geometry</span><span class="p">(</span><span class="n">execute_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract center coordinates, frame and projection hints from metadata/execute text.</span>

<span class="sd">    Returns:</span>
<span class="sd">      (coords, frame, projection)</span>
<span class="sd">      - coords: (x, y) as floats</span>
<span class="sd">      - frame: one of {&quot;hpc&quot;,&quot;hgc&quot;,&quot;hgs&quot;} or None</span>
<span class="sd">      - projection: one of {&quot;cea&quot;,&quot;top&quot;} or None</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">execute_text</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">execute_text</span><span class="p">)</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">frame</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">projection</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Python CLI style: --coords X Y [--hpc|--hgc|--hgs] [--cea|--top]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">token</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--coords&quot;</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">token</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--coords=&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="n">token</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">float</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--hpc&quot;</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;hpc&quot;</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--hgc&quot;</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;hgc&quot;</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--hgs&quot;</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;hgs&quot;</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--cea&quot;</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="s2">&quot;cea&quot;</span>
        <span class="k">elif</span> <span class="n">token</span> <span class="o">==</span> <span class="s2">&quot;--top&quot;</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="s2">&quot;top&quot;</span>

    <span class="c1"># IDL canonical pattern:</span>
    <span class="c1"># CENTER_ARCSEC=[ -280, -250]</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;\bCENTER_ARCSEC\s*=\s*\[\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*\]&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span> <span class="ow">or</span> <span class="s2">&quot;hpc&quot;</span>

    <span class="c1"># Optional degree-based patterns.</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;\bCENTER_HGC\s*=\s*\[\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*\]&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;hgc&quot;</span>
    <span class="k">if</span> <span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;\bCENTER_HGS\s*=\s*\[\s*([+-]?\d+(?:\.\d+)?)\s*,\s*([+-]?\d+(?:\.\d+)?)\s*\]&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="p">,</span>
            <span class="n">flags</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">IGNORECASE</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
            <span class="n">coords</span> <span class="o">=</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="nb">float</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="s2">&quot;hgs&quot;</span>

    <span class="c1"># Projection hint in IDL execute.</span>
    <span class="k">if</span> <span class="n">projection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">up</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot; /TOP&quot;</span> <span class="ow">in</span> <span class="n">up</span> <span class="ow">or</span> <span class="s2">&quot;, TOP=1&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="s2">&quot;top&quot;</span>
        <span class="k">elif</span> <span class="s2">&quot; /CEA&quot;</span> <span class="ow">in</span> <span class="n">up</span> <span class="ow">or</span> <span class="s2">&quot;, CEA=1&quot;</span> <span class="ow">in</span> <span class="n">up</span><span class="p">:</span>
            <span class="n">projection</span> <span class="o">=</span> <span class="s2">&quot;cea&quot;</span>

    <span class="k">return</span> <span class="n">coords</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">projection</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_flag_explicit_on_cli</span><span class="p">(</span><span class="n">flag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">arg</span> <span class="o">==</span> <span class="n">flag</span> <span class="ow">or</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">flag</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_warn_path_default</span><span class="p">(</span><span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">path_text</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">path_text</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">return</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parent</span>
    <span class="k">if</span> <span class="n">parent</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2"> from metadata/execute does not exist yet: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2"> (will be used as requested).&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2"> parent directory does not exist on this system: </span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_lines_quiet</span><span class="p">(</span><span class="n">maglib</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Suppress noisy stdout/stderr emitted by the underlying line tracer.&quot;&quot;&quot;</span>
    <span class="n">sink</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stdout</span><span class="p">(</span><span class="n">sink</span><span class="p">),</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">redirect_stderr</span><span class="p">(</span><span class="n">sink</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">maglib</span><span class="o">.</span><span class="n">lines</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_decode_id_text</span><span class="p">(</span><span class="n">v</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;b&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;b&quot;&#39;</span><span class="p">,</span> <span class="s2">&quot;B&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;B&quot;&#39;</span><span class="p">)):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Normalize uppercase byte literal prefix (e.g. B&#39;CEA&#39;) to valid Python syntax.</span>
            <span class="n">lit_src</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;b</span><span class="si">{</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">s</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span> <span class="k">else</span> <span class="n">s</span>
            <span class="n">lit</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">lit_src</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lit</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">bytearray</span><span class="p">)):</span>
                <span class="k">return</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">lit</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_split_stage_id</span><span class="p">(</span><span class="n">model_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
    <span class="n">sid</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">model_id</span><span class="p">)</span>
    <span class="n">up</span> <span class="o">=</span> <span class="n">sid</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;.POT.GEN.CHR&quot;</span><span class="p">,</span> <span class="s2">&quot;.NAS.GEN.CHR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.POT.CHR&quot;</span><span class="p">,</span> <span class="s2">&quot;.NAS.CHR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.POT.GEN&quot;</span><span class="p">,</span> <span class="s2">&quot;.NAS.GEN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;.NAS&quot;</span><span class="p">,</span> <span class="s2">&quot;.BND&quot;</span><span class="p">,</span> <span class="s2">&quot;.POT&quot;</span><span class="p">,</span> <span class="s2">&quot;.NONE&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">up</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">suffix</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sid</span><span class="p">[:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)],</span> <span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_canonical_lineage_suffix</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;NONE&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;POT&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT&quot;</span><span class="p">,</span>
        <span class="s2">&quot;BND&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.BND&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NAS&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.BND.NAS&quot;</span><span class="p">,</span>
        <span class="s2">&quot;POT.GEN&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.GEN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;POT.CHR&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.CHR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;POT.GEN.CHR&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.GEN.CHR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NAS.GEN&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.BND.NAS.GEN&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NAS.CHR&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.BND.NAS.CHR&quot;</span><span class="p">,</span>
        <span class="s2">&quot;NAS.GEN.CHR&quot;</span><span class="p">:</span> <span class="s2">&quot;NONE.POT.BND.NAS.GEN.CHR&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_merge_lineage</span><span class="p">(</span><span class="n">root</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">suffix</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">root</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">suffix</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">max_k</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="n">overlap</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">:]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[:</span><span class="n">i</span><span class="p">]:</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">break</span>
    <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span> <span class="o">+</span> <span class="n">s</span><span class="p">[</span><span class="n">overlap</span><span class="p">:])</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_lineage_delta_from_entry</span><span class="p">(</span><span class="n">entry_stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">saved_stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return lineage segment from entry stage to saved stage (inclusive of implied steps).&quot;&quot;&quot;</span>
    <span class="n">e</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_canonical_lineage_suffix</span><span class="p">(</span><span class="n">entry_stage_tag</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">_canonical_lineage_suffix</span><span class="p">(</span><span class="n">saved_stage_tag</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="n">t</span><span class="p">]</span>
    <span class="c1"># Remove shared prefix (e.g., NONE.POT), keep what was computed after entry.</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="ow">and</span> <span class="n">e</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">tail</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tail</span><span class="p">:</span>
        <span class="c1"># Clone/self-save: keep explicit stage identity on RHS.</span>
        <span class="k">return</span> <span class="n">saved_stage_tag</span>
    <span class="k">return</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_should_save_stage</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">Fov2BoxConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="n">stop_tag</span> <span class="o">=</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">stop_tag</span> <span class="o">==</span> <span class="s2">&quot;GEN&quot;</span> <span class="ow">and</span> <span class="n">stage_tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NAS.GEN&quot;</span><span class="p">,</span> <span class="s2">&quot;POT.GEN&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">stop_tag</span> <span class="o">==</span> <span class="s2">&quot;CHR&quot;</span> <span class="ow">and</span> <span class="n">stage_tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.CHR&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="n">stop_tag</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_potential</span>
    <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_nas</span>
    <span class="k">if</span> <span class="n">stage_tag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NAS.GEN&quot;</span><span class="p">,</span> <span class="s2">&quot;POT.GEN&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_gen</span>
    <span class="k">if</span> <span class="n">stage_tag</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.CHR&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_chr</span>
    <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_empty_box</span>
    <span class="k">if</span> <span class="n">stage_tag</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_bounds</span>
    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_execute_cmd</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Fov2BoxConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;gx-fov2box&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--time&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">time</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--coords&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--hpc&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgc</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--hgc&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--hgs&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--top&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">cea</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--cea&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">box_dims</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--box-dims&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">box_dims</span><span class="p">)]</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--dx-km&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--pad-frac&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">pad_frac</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--data-dir&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_dir</span><span class="p">]</span>
    <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--gxmodel-dir&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">euv</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--euv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">uv</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--uv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_empty_box</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-empty-box&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_potential</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-potential&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_bounds</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-bounds&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_nas</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-nas&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_gen</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-gen&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_chr</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--save-chr&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">empty_box_only</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--empty-box-only&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">potential_only</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--potential-only&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nlfff_only</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--nlfff-only&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">generic_only</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--generic-only&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_potential</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--use-potential&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--skip-lines&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">center_vox</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--center-vox&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--reduce-passed&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--entry-box&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sfq</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--sfq&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">:</span>
        <span class="n">cmd</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;--stop-after&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2potential</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2potential&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2bounds</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2bounds&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2nlfff</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2nlfff&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2lines</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2lines&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2chromo</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--jump2chromo&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--rebuild&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--rebuild-from-none&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone_only</span><span class="p">:</span>
        <span class="n">cmd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--clone-only&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shlex</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_index_header</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">source_map</span><span class="p">:</span> <span class="n">Map</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an IDL-GX compatible INDEX-like FITS header string.</span>

<span class="sd">    This mirrors the intent of IDL `wcs2fitshead(..., /structure)` for the</span>
<span class="sd">    base map WCS: preserve WCS cards and add key TIME/POSITION cards expected</span>
<span class="sd">    by legacy GX Simulator routines.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Normalize to IDL-GX conventions used in box.index.</span>
    <span class="n">ctype1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">ctype2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ctype1</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HGLN-&quot;</span><span class="p">):</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRLN-&quot;</span> <span class="o">+</span> <span class="n">ctype1</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ctype2</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;HGLT-&quot;</span><span class="p">):</span>
        <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CTYPE2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;CRLT-&quot;</span> <span class="o">+</span> <span class="n">ctype2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;SIMPLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">bool</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SIMPLE&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BITPIX&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
    <span class="n">header</span><span class="p">[</span><span class="s2">&quot;NAXIS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;NAXIS&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">source_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">date_obs</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">isot</span> <span class="k">if</span> <span class="n">source_map</span><span class="o">.</span><span class="n">date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">date_obs</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
        <span class="k">elif</span> <span class="s2">&quot;DATE-OBS&quot;</span> <span class="ow">in</span> <span class="n">header</span> <span class="ow">and</span> <span class="s2">&quot;DATE_OBS&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DATE-OBS&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source_map</span><span class="p">,</span> <span class="s2">&quot;dsun&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">source_map</span><span class="o">.</span><span class="n">dsun</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;DSUN_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">source_map</span><span class="o">.</span><span class="n">dsun</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">observer_coordinate</span>
        <span class="k">if</span> <span class="n">obs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obs_hgs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicStonyhurst</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">source_map</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;HGLN_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgs</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;HGLT_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgs</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;SOLAR_B0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgs</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">obs_hgc</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicCarrington</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="s2">&quot;earth&quot;</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">source_map</span><span class="o">.</span><span class="n">date</span><span class="p">))</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRLN_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgc</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
                <span class="n">header</span><span class="p">[</span><span class="s2">&quot;CRLT_OBS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">obs_hgc</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If Carrington transformation fails (e.g. unsupported observer configuration),</span>
                <span class="c1"># proceed without CRLN_OBS/CRLT_OBS rather than aborting header creation.</span>
                <span class="c1"># Carrington observer transforms can fail for some observer metadata;</span>
                <span class="c1"># keep header generation robust and proceed with available keys.</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">source_map</span><span class="p">,</span> <span class="s2">&quot;rsun_meters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;RSUN_REF&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">source_map</span><span class="o">.</span><span class="n">rsun_meters</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">))</span>

        <span class="n">tel</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;telescop&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">tel</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;TELESCOP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tel</span><span class="p">)</span>
        <span class="n">instr</span> <span class="o">=</span> <span class="n">source_map</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;instrume&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">instr</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;INSTRUME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">instr</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;WCSNAME&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header</span><span class="p">:</span>
            <span class="n">header</span><span class="p">[</span><span class="s2">&quot;WCSNAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Carrington-Heliographic&quot;</span>

    <span class="k">return</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_print_info</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Fov2BoxConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">resolved_reduce_passed</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">center_vox</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">pyampp</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">sunpy</span>

    <span class="n">runtime_rows</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;python_executable&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="s2">&quot;Interpreter used for this run&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;python_version&quot;</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Python runtime version&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gx_fov2box_module&quot;</span><span class="p">,</span> <span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;Loaded gx_fov2box module path&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;pyampp_module&quot;</span><span class="p">,</span> <span class="n">pyampp</span><span class="o">.</span><span class="vm">__file__</span><span class="p">,</span> <span class="s2">&quot;Loaded pyampp package path&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;sunpy_version&quot;</span><span class="p">,</span> <span class="n">sunpy</span><span class="o">.</span><span class="n">__version__</span><span class="p">,</span> <span class="s2">&quot;Loaded sunpy version&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gx-fov2box_cli&quot;</span><span class="p">,</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;gx-fov2box&quot;</span><span class="p">),</span> <span class="s2">&quot;Resolved CLI entry point on PATH&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="s2">&quot;Observation time in ISO format&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;coords&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span> <span class="s2">&quot;Center coordinates: arcsec (HPC) or degrees (HGC/HGS)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;hpc/hgc/hgs&quot;</span><span class="p">,</span> <span class="s2">&quot;HPC&quot;</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span> <span class="k">else</span> <span class="s2">&quot;HGC&quot;</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgc</span> <span class="k">else</span> <span class="s2">&quot;HGS&quot;</span><span class="p">,</span> <span class="s2">&quot;Coordinate frame&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;cea/top&quot;</span><span class="p">,</span> <span class="s2">&quot;TOP&quot;</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span> <span class="k">else</span> <span class="s2">&quot;CEA&quot;</span><span class="p">,</span> <span class="s2">&quot;Basemap projection&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;box_dims&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">box_dims</span><span class="p">,</span> <span class="s2">&quot;Box dimensions (nx, ny, nz) in pixels&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;dx_km&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span><span class="p">,</span> <span class="s2">&quot;Voxel size in km&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;pad_frac&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">pad_frac</span><span class="p">,</span> <span class="s2">&quot;Padding fraction used for context map FOV&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;data_dir&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s2">&quot;SDO download/cache directory&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gxmodel_dir&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="p">,</span> <span class="s2">&quot;Output gx_models directory&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;entry_box&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">,</span> <span class="s2">&quot;Path to precomputed HDF5 box&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;save_empty_box&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_empty_box</span><span class="p">,</span> <span class="s2">&quot;Save NONE stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;save_potential&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_potential</span><span class="p">,</span> <span class="s2">&quot;Save POT stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;save_bounds&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_bounds</span><span class="p">,</span> <span class="s2">&quot;Save BND stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;save_nas&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_nas</span><span class="p">,</span> <span class="s2">&quot;Save NAS stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;save_gen&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_gen</span><span class="p">,</span> <span class="s2">&quot;Save NAS.GEN stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;save_chr&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">save_chr</span><span class="p">,</span> <span class="s2">&quot;Save NAS.CHR stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;stop_after&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">,</span> <span class="s2">&quot;Stop after stage (dl/none/bnd/pot/nas/gen/chr)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;empty_box_only&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">empty_box_only</span><span class="p">,</span> <span class="s2">&quot;Stop after NONE stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;potential_only&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">potential_only</span><span class="p">,</span> <span class="s2">&quot;Stop after POT stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;nlfff_only&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nlfff_only</span><span class="p">,</span> <span class="s2">&quot;Stop after NAS stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;generic_only&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">generic_only</span><span class="p">,</span> <span class="s2">&quot;Stop after NAS.GEN stage&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;use_potential&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_potential</span><span class="p">,</span> <span class="s2">&quot;Skip NLFFF; reuse potential field&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;skip_lines&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">,</span> <span class="s2">&quot;Skip GEN line computation and proceed directly to CHR&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;center_vox&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">center_vox</span><span class="p">,</span> <span class="s2">&quot;Compute lines only through voxel centers (sets reduce_passed=0 unless overridden)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;reduce_passed&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span><span class="p">,</span> <span class="s2">&quot;Expert override: 0|1|2|3 (takes precedence over --center-vox)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;reduce_passed_resolved&quot;</span><span class="p">,</span> <span class="n">resolved_reduce_passed</span><span class="p">,</span> <span class="s2">&quot;Effective line-reduction mode used by tracer&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;euv&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">euv</span><span class="p">,</span> <span class="s2">&quot;Download AIA EUV context maps&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;uv&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">uv</span><span class="p">,</span> <span class="s2">&quot;Download AIA UV context maps&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;sfq&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sfq</span><span class="p">,</span> <span class="s2">&quot;Use SFQ disambiguation (method=0)&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;jump2potential&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2potential</span><span class="p">,</span> <span class="s2">&quot;Start from entry box and jump to POT&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;jump2bounds&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2bounds</span><span class="p">,</span> <span class="s2">&quot;Start from entry box and jump to BND&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;jump2nlfff&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2nlfff</span><span class="p">,</span> <span class="s2">&quot;Start from entry box and jump to NAS&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;jump2lines&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2lines</span><span class="p">,</span> <span class="s2">&quot;Start from entry box and jump to GEN&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;jump2chromo&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2chromo</span><span class="p">,</span> <span class="s2">&quot;Start from entry box and jump to CHR&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;rebuild&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span><span class="p">,</span> <span class="s2">&quot;Ignore entry stage payload and rebuild from NONE&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;rebuild_from_none&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span><span class="p">,</span> <span class="s2">&quot;Strip entry to NONE-equivalent and continue forward&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;clone_only&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone_only</span><span class="p">,</span> <span class="s2">&quot;Convert/copy entry-box to normalized H5 without recomputation&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;gx-fov2box --info&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">desc</span> <span class="ow">in</span> <span class="n">runtime_rows</span> <span class="o">+</span> <span class="n">rows</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> :: </span><span class="si">{</span><span class="n">desc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">time</span><span class="p">:</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--time&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">:</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--coords&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">box_dims</span><span class="p">:</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;--box-dims&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warnings:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">missing</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- Missing required </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- entry_box provided; time/box-dims may be inferred if present&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_hmi_maps_from_downloader</span><span class="p">(</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">Time</span><span class="p">,</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span>
    <span class="n">euv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">uv</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
    <span class="n">disambig_method</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">strict_required</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Map</span><span class="p">],</span> <span class="nb">dict</span><span class="p">]:</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">time_mod</span>

    <span class="n">downloader</span> <span class="o">=</span> <span class="n">SDOImageDownloader</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">data_dir</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">data_dir</span><span class="p">),</span> <span class="n">euv</span><span class="o">=</span><span class="n">euv</span><span class="p">,</span> <span class="n">uv</span><span class="o">=</span><span class="n">uv</span><span class="p">,</span> <span class="n">hmi</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">missing_before</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">downloader</span><span class="o">.</span><span class="n">existence_report</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;hmi_b&quot;</span><span class="p">,</span> <span class="s2">&quot;hmi_m&quot;</span><span class="p">,</span> <span class="s2">&quot;hmi_ic&quot;</span><span class="p">):</span>
            <span class="n">items</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">existence_report</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">category</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">missing_before</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">exists</span> <span class="ow">in</span> <span class="n">items</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">])</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">downloader</span><span class="o">.</span><span class="n">download_images</span><span class="p">()</span>
    <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
    <span class="n">downloaded</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_before</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">required</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">,</span> <span class="s2">&quot;inclination&quot;</span><span class="p">,</span> <span class="s2">&quot;azimuth&quot;</span><span class="p">,</span> <span class="s2">&quot;disambig&quot;</span><span class="p">,</span> <span class="s2">&quot;continuum&quot;</span><span class="p">,</span> <span class="s2">&quot;magnetogram&quot;</span><span class="p">]</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">missing</span> <span class="ow">and</span> <span class="n">strict_required</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing required HMI files: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">missing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">strict_required</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;downloaded&quot;</span><span class="p">:</span> <span class="n">downloaded</span><span class="p">,</span> <span class="s2">&quot;elapsed&quot;</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s2">&quot;missing_before&quot;</span><span class="p">:</span> <span class="n">missing_before</span><span class="p">,</span> <span class="s2">&quot;missing_after&quot;</span><span class="p">:</span> <span class="n">missing</span><span class="p">,</span> <span class="s2">&quot;files&quot;</span><span class="p">:</span> <span class="n">files</span><span class="p">}</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="n">info</span>

    <span class="n">map_field</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">])</span>
    <span class="n">map_inclination</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;inclination&quot;</span><span class="p">])</span>
    <span class="n">map_azimuth</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;azimuth&quot;</span><span class="p">])</span>
    <span class="n">map_disambig</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;disambig&quot;</span><span class="p">])</span>
    <span class="n">map_conti</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;continuum&quot;</span><span class="p">])</span>
    <span class="n">map_losma</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">files</span><span class="p">[</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">])</span>

    <span class="n">map_azimuth</span> <span class="o">=</span> <span class="n">hmi_disambig</span><span class="p">(</span><span class="n">map_azimuth</span><span class="p">,</span> <span class="n">map_disambig</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">disambig_method</span><span class="p">)</span>

    <span class="n">maps</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">map_field</span><span class="p">,</span>
        <span class="s2">&quot;inclination&quot;</span><span class="p">:</span> <span class="n">map_inclination</span><span class="p">,</span>
        <span class="s2">&quot;azimuth&quot;</span><span class="p">:</span> <span class="n">map_azimuth</span><span class="p">,</span>
        <span class="s2">&quot;disambig&quot;</span><span class="p">:</span> <span class="n">map_disambig</span><span class="p">,</span>
        <span class="s2">&quot;continuum&quot;</span><span class="p">:</span> <span class="n">map_conti</span><span class="p">,</span>
        <span class="s2">&quot;magnetogram&quot;</span><span class="p">:</span> <span class="n">map_losma</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;field&quot;</span><span class="p">,</span> <span class="s2">&quot;inclination&quot;</span><span class="p">,</span> <span class="s2">&quot;azimuth&quot;</span><span class="p">,</span> <span class="s2">&quot;disambig&quot;</span><span class="p">,</span> <span class="s2">&quot;continuum&quot;</span><span class="p">,</span> <span class="s2">&quot;magnetogram&quot;</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">maps</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;AIA_</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">load_sunpy_map_compat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Skip optional context channels that cannot be loaded.</span>
            <span class="k">continue</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;downloaded&quot;</span><span class="p">:</span> <span class="n">downloaded</span><span class="p">,</span> <span class="s2">&quot;elapsed&quot;</span><span class="p">:</span> <span class="n">elapsed</span><span class="p">,</span> <span class="s2">&quot;missing_before&quot;</span><span class="p">:</span> <span class="n">missing_before</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">maps</span><span class="p">,</span> <span class="n">info</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_header</span><span class="p">(</span><span class="n">map_field</span><span class="p">:</span> <span class="n">Map</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="n">header_field</span> <span class="o">=</span> <span class="n">map_field</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
    <span class="n">field_frame</span> <span class="o">=</span> <span class="n">map_field</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">heliographic_carrington</span><span class="o">.</span><span class="n">frame</span>
    <span class="n">lon</span><span class="p">,</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">field_frame</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">field_frame</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">value</span>
    <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">map_field</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
    <span class="n">dsun_obs</span> <span class="o">=</span> <span class="n">header_field</span><span class="p">[</span><span class="s2">&quot;DSUN_OBS&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;lon&quot;</span><span class="p">:</span> <span class="n">lon</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">:</span> <span class="n">lat</span><span class="p">,</span> <span class="s2">&quot;dsun_obs&quot;</span><span class="p">:</span> <span class="n">dsun_obs</span><span class="p">,</span> <span class="s2">&quot;obs_time&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obs_time</span><span class="o">.</span><span class="n">iso</span><span class="p">)}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_lines_group</span><span class="p">(</span><span class="n">lines</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">dr3</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">group</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dr3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;start_idx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end_idx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;seed_idx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;apex_idx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;codes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;av_field&quot;</span><span class="p">,</span>
        <span class="s2">&quot;phys_length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;voxel_status&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">group</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">group</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_make_chromo_group</span><span class="p">(</span><span class="n">chromo_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">group</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;chromo_idx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chromo_n&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chromo_t&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_p&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_hi&quot;</span><span class="p">,</span>
        <span class="s2">&quot;n_htot&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tr&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tr_h&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chromo_layers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;dz&quot;</span><span class="p">,</span>
        <span class="s2">&quot;chromo_mask&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">chromo_box</span><span class="p">:</span>
            <span class="n">group</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_box</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="c1"># Export CHR vectors explicitly in H5 (no BCUBE replacement in schema).</span>
    <span class="n">chromo_bcube</span> <span class="o">=</span> <span class="n">chromo_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromo_bcube&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">chromo_bcube</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">chromo_bcube</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">chromo_bcube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">group</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_bcube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">group</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_bcube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo_bcube</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">group</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_to_h5_2d</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot normalize 2D map shape </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to (ny,nx)=(</span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_to_h5_3d</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize internal cube to H5 canonical order (nz, ny, nx).</span>
<span class="sd">    Accepts common permutations used by current pipeline.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>  <span class="c1"># already z,y,x</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>  <span class="c1"># y,x,z</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>  <span class="c1"># x,y,z</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>  <span class="c1"># z,x,y</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot normalize 3D cube shape </span><span class="si">{</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> to (nz,ny,nx) with (ny,nx)=(</span><span class="si">{</span><span class="n">ny</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">nx</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_normalize_stage_for_h5</span><span class="p">(</span><span class="n">stage_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stage_box</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;base&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">out</span>
    <span class="n">base</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;bx&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">elif</span> <span class="s2">&quot;bz&quot;</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>
        <span class="k">return</span> <span class="n">out</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">,</span> <span class="s2">&quot;ic&quot;</span><span class="p">,</span> <span class="s2">&quot;chromo_mask&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">base</span><span class="p">:</span>
            <span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to_h5_2d</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>

    <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">corona</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">corona</span><span class="p">:</span>
                <span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to_h5_3d</span><span class="p">(</span><span class="n">corona</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corona</span>

    <span class="k">if</span> <span class="s2">&quot;chromo&quot;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">chromo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">,</span> <span class="s2">&quot;dz&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chromo</span><span class="p">:</span>
                <span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to_h5_3d</span><span class="p">(</span><span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">,</span> <span class="s2">&quot;tr_h&quot;</span><span class="p">,</span> <span class="s2">&quot;chromo_mask&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">chromo</span><span class="p">:</span>
                <span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to_h5_2d</span><span class="p">(</span><span class="n">chromo</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo</span>

    <span class="k">if</span> <span class="s2">&quot;grid&quot;</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;voxel_id&quot;</span><span class="p">,</span> <span class="s2">&quot;dz&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">grid</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">grid</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">_to_h5_3d</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_h5_corona_to_internal_xyz</span><span class="p">(</span><span class="n">corona</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">axis_order_3d</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">corona</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">corona</span>
    <span class="k">if</span> <span class="n">axis_order_3d</span> <span class="o">!=</span> <span class="s2">&quot;zyx&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">corona</span>
    <span class="n">out</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">corona</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">out</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ny</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">nx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="c1"># SAV restores commonly as (z,y,x) or (x,y,z); normalize to internal (x,y,z).</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>   <span class="c1"># z,y,x</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>   <span class="c1"># x,y,z</span>
        <span class="k">return</span> <span class="n">a</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">):</span>   <span class="c1"># y,x,z</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">==</span> <span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>   <span class="c1"># z,x,y</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">transpose</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">a</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_decode_sav_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;item&quot;</span><span class="p">):</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">v</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_entry_box_any</span><span class="p">(</span><span class="n">entry_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;.h5&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">read_b3d_h5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry_path</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;.sav&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--entry-box must be .h5 or .sav, got: </span><span class="si">{</span><span class="n">entry_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">readsav</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">entry_path</span><span class="p">),</span> <span class="n">python_dict</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;box&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;box&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s2">&quot;pbox&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">box</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;pbox&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SAV entry box missing box/pbox structure: </span><span class="si">{</span><span class="n">entry_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">box</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s2">&quot;BASE&quot;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
        <span class="n">base_raw</span> <span class="o">=</span> <span class="n">box</span><span class="p">[</span><span class="s2">&quot;BASE&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">bnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">base_raw</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">names</span> <span class="ow">or</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="p">{</span><span class="s2">&quot;BX&quot;</span><span class="p">,</span> <span class="s2">&quot;BY&quot;</span><span class="p">,</span> <span class="s2">&quot;BZ&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">bnames</span><span class="p">):</span>
            <span class="n">base</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_raw</span><span class="p">[</span><span class="s2">&quot;BX&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_raw</span><span class="p">[</span><span class="s2">&quot;BY&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_raw</span><span class="p">[</span><span class="s2">&quot;BZ&quot;</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;IC&quot;</span> <span class="ow">in</span> <span class="n">bnames</span><span class="p">:</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;ic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_raw</span><span class="p">[</span><span class="s2">&quot;IC&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;CHROMO_MASK&quot;</span> <span class="ow">in</span> <span class="n">bnames</span><span class="p">:</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;chromo_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_raw</span><span class="p">[</span><span class="s2">&quot;CHROMO_MASK&quot;</span><span class="p">])</span>
            <span class="k">if</span> <span class="s2">&quot;INDEX&quot;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">base</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_decode_sav_value</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;INDEX&quot;</span><span class="p">])</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base</span>

    <span class="n">ny</span> <span class="o">=</span> <span class="n">nx</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1"># Build corona from BX/BY/BZ or BCUBE.</span>
    <span class="k">if</span> <span class="p">{</span><span class="s2">&quot;BX&quot;</span><span class="p">,</span> <span class="s2">&quot;BY&quot;</span><span class="p">,</span> <span class="s2">&quot;BZ&quot;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">names</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ny</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;BX&quot;</span><span class="p">]),</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;BY&quot;</span><span class="p">]),</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;BZ&quot;</span><span class="p">]),</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">},</span>
        <span class="p">}</span>
    <span class="k">elif</span> <span class="s2">&quot;BCUBE&quot;</span> <span class="ow">in</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">ny</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">bc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;BCUBE&quot;</span><span class="p">])</span>
        <span class="c1"># scipy commonly restores BCUBE as (comp, z, y, x)</span>
        <span class="k">if</span> <span class="n">bc</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">bc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">bc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;unknown&quot;</span><span class="p">},</span>
            <span class="p">}</span>

    <span class="c1"># Lines metadata if present.</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;STARTIDX&quot;</span><span class="p">,</span> <span class="s2">&quot;ENDIDX&quot;</span><span class="p">,</span> <span class="s2">&quot;SEED_IDX&quot;</span><span class="p">,</span> <span class="s2">&quot;SEEDIDX&quot;</span><span class="p">,</span> <span class="s2">&quot;APEX_IDX&quot;</span><span class="p">,</span> <span class="s2">&quot;APEXIDX&quot;</span><span class="p">,</span> <span class="s2">&quot;CODES&quot;</span><span class="p">,</span>
              <span class="s2">&quot;AVFIELD&quot;</span><span class="p">,</span> <span class="s2">&quot;PHYSLENGTH&quot;</span><span class="p">,</span> <span class="s2">&quot;STATUS&quot;</span><span class="p">,</span> <span class="s2">&quot;VOXEL_STATUS&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;startidx&quot;</span><span class="p">,</span> <span class="s2">&quot;start_idx&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;endidx&quot;</span><span class="p">,</span> <span class="s2">&quot;end_idx&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;seedidx&quot;</span><span class="p">,</span> <span class="s2">&quot;seed_idx&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;apexidx&quot;</span><span class="p">,</span> <span class="s2">&quot;apex_idx&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;avfield&quot;</span><span class="p">,</span> <span class="s2">&quot;av_field&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;physlength&quot;</span><span class="p">,</span> <span class="s2">&quot;phys_length&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel_status&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">lines</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span>

    <span class="c1"># CHR fields if present.</span>
    <span class="n">chromo</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;CHROMO_IDX&quot;</span><span class="p">,</span> <span class="s2">&quot;CHROMO_N&quot;</span><span class="p">,</span> <span class="s2">&quot;CHROMO_T&quot;</span><span class="p">,</span> <span class="s2">&quot;N_P&quot;</span><span class="p">,</span> <span class="s2">&quot;N_HI&quot;</span><span class="p">,</span> <span class="s2">&quot;N_HTOT&quot;</span><span class="p">,</span> <span class="s2">&quot;TR&quot;</span><span class="p">,</span> <span class="s2">&quot;TR_H&quot;</span><span class="p">,</span>
              <span class="s2">&quot;CHROMO_LAYERS&quot;</span><span class="p">,</span> <span class="s2">&quot;DZ&quot;</span><span class="p">,</span> <span class="s2">&quot;CHROMO_MASK&quot;</span><span class="p">,</span> <span class="s2">&quot;CHROMO_BCUBE&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
            <span class="n">kk</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">chromo</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
    <span class="k">if</span> <span class="s2">&quot;CHROMO_BCUBE&quot;</span> <span class="ow">in</span> <span class="n">names</span> <span class="ow">and</span> <span class="n">ny</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">nx</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cbc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;CHROMO_BCUBE&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">cbc</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">cbc</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">chromo</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">cbc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
            <span class="n">chromo</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">cbc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
            <span class="n">chromo</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_sav_cube_to_internal_xyz</span><span class="p">(</span><span class="n">cbc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">chromo</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chromo</span>

    <span class="n">sid</span> <span class="o">=</span> <span class="n">_decode_sav_value</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;ID&quot;</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">else</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">execute</span> <span class="o">=</span> <span class="n">_decode_sav_value</span><span class="p">(</span><span class="n">box</span><span class="p">[</span><span class="s2">&quot;EXECUTE&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="s2">&quot;EXECUTE&quot;</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">out</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">sid</span><span class="p">,</span> <span class="s2">&quot;execute&quot;</span><span class="p">:</span> <span class="n">execute</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_resolve_box_params</span><span class="p">(</span><span class="n">cfg</span><span class="p">:</span> <span class="n">Fov2BoxConfig</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Time</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">float</span><span class="p">]:</span>
    <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">time</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">box_dims</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">box_dims</span>
    <span class="n">dx_km</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
        <span class="n">entry_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">,</span> <span class="s2">&quot;.sav&quot;</span><span class="p">):</span>
            <span class="n">box_b3d</span> <span class="o">=</span> <span class="n">_load_entry_box_any</span><span class="p">(</span><span class="n">entry_path</span><span class="p">)</span>
            <span class="n">corona</span> <span class="o">=</span> <span class="n">box_b3d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corona&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">corona</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">box_dims</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;bx&quot;</span> <span class="ow">in</span> <span class="n">corona</span><span class="p">:</span>
                    <span class="n">shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">corona</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">axis_order</span> <span class="o">=</span> <span class="n">box_b3d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;axis_order_3d&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">axis_order</span> <span class="o">==</span> <span class="s2">&quot;zyx&quot;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="n">box_dims</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># internal cubes are x,y,z unless metadata says zyx</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                            <span class="n">box_dims</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">box_dims</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;dr&quot;</span> <span class="ow">in</span> <span class="n">corona</span> <span class="ow">and</span> <span class="n">dx_km</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dr3</span> <span class="o">=</span> <span class="n">corona</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">]</span>
                    <span class="n">dx_km</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sun_consts</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">inferred</span> <span class="o">=</span> <span class="n">_infer_time_from_path</span><span class="p">(</span><span class="n">entry_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">inferred</span><span class="p">:</span>
                <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">inferred</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obs_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--time is required unless it can be inferred from entry_box&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">box_dims</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--box-dims is required unless it can be inferred from entry_box&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obs_time</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">box_dims</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">dx_km</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<div class="viewcode-block" id="main">
<a class="viewcode-back" href="../../../autoapi/pyampp/gxbox/gx_fov2box/index.html#pyampp.gxbox.gx_fov2box.main">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span>
    <span class="n">time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--time&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Observation time ISO (e.g. 2024-05-12T00:00:00)&quot;</span><span class="p">),</span>
    <span class="n">coords</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--coords&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Center coords (x y)&quot;</span><span class="p">),</span>
    <span class="n">hpc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--hpc/--no-hpc&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use helioprojective coordinates&quot;</span><span class="p">),</span>
    <span class="n">hgc</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--hgc/--no-hgc&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use heliographic carrington coordinates&quot;</span><span class="p">),</span>
    <span class="n">hgs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--hgs/--no-hgs&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use heliographic stonyhurst coordinates&quot;</span><span class="p">),</span>
    <span class="n">cea</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--cea&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use CEA basemap projection&quot;</span><span class="p">),</span>
    <span class="n">top</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--top&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use TOP-view basemap projection&quot;</span><span class="p">),</span>
    <span class="n">box_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--box-dims&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Box dims in pixels&quot;</span><span class="p">),</span>
    <span class="n">dx_km</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="mf">1400.0</span><span class="p">,</span> <span class="s2">&quot;--dx-km&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Voxel size in km&quot;</span><span class="p">),</span>
    <span class="n">pad_frac</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="mf">0.10</span><span class="p">,</span> <span class="s2">&quot;--pad-frac&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Padding fraction for FOV&quot;</span><span class="p">),</span>
    <span class="n">data_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="n">DOWNLOAD_DIR</span><span class="p">,</span> <span class="s2">&quot;--data-dir&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;SDO data directory&quot;</span><span class="p">),</span>
    <span class="n">gxmodel_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="n">GXMODEL_DIR</span><span class="p">,</span> <span class="s2">&quot;--gxmodel-dir&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;GX model output directory&quot;</span><span class="p">),</span>
    <span class="n">entry_box</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--entry-box&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Existing HDF5/SAV box&quot;</span><span class="p">),</span>
    <span class="n">save_empty_box</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--save-empty-box&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save NONE stage&quot;</span><span class="p">),</span>
    <span class="n">save_potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--save-potential&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save POT stage&quot;</span><span class="p">),</span>
    <span class="n">save_bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--save-bounds&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save BND stage&quot;</span><span class="p">),</span>
    <span class="n">save_nas</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--save-nas&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save NAS stage&quot;</span><span class="p">),</span>
    <span class="n">save_gen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--save-gen&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save NAS.GEN stage&quot;</span><span class="p">),</span>
    <span class="n">save_chr</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--save-chr&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Save NAS.CHR stage&quot;</span><span class="p">),</span>
    <span class="n">stop_after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;--stop-after&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after stage (dl/none/pot/bnd/nas/gen/chr)&quot;</span><span class="p">),</span>
    <span class="n">empty_box_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--empty-box-only&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after NONE&quot;</span><span class="p">),</span>
    <span class="n">potential_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--potential-only&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after POT&quot;</span><span class="p">),</span>
    <span class="n">nlfff_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--nlfff-only&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after NAS&quot;</span><span class="p">),</span>
    <span class="n">generic_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--generic-only&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Stop after NAS.GEN&quot;</span><span class="p">),</span>
    <span class="n">use_potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--use-potential&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip NLFFF&quot;</span><span class="p">),</span>
    <span class="n">skip_lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--skip-lines&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Skip GEN line computation and go directly to CHR&quot;</span><span class="p">),</span>
    <span class="n">center_vox</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--center-vox&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Trace lines through voxel centers&quot;</span><span class="p">),</span>
    <span class="n">reduce_passed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span>
        <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;--reduce-passed&quot;</span><span class="p">,</span>
        <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="nb">max</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Expert line tracing reduction bitmask: 0|1|2|3 (overrides --center-vox)&quot;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">euv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--euv&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Download AIA EUV maps&quot;</span><span class="p">),</span>
    <span class="n">uv</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--uv&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Download AIA UV maps&quot;</span><span class="p">),</span>
    <span class="n">sfq</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--sfq&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Use SFQ disambiguation (method=0)&quot;</span><span class="p">),</span>
    <span class="n">jump2potential</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--jump2potential&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Jump to POT&quot;</span><span class="p">),</span>
    <span class="n">jump2bounds</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--jump2bounds&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Jump to BND&quot;</span><span class="p">),</span>
    <span class="n">jump2nlfff</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--jump2nlfff&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Jump to NAS&quot;</span><span class="p">),</span>
    <span class="n">jump2lines</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--jump2lines&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Jump to GEN&quot;</span><span class="p">),</span>
    <span class="n">jump2chromo</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--jump2chromo&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Jump to CHR&quot;</span><span class="p">),</span>
    <span class="n">rebuild</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--rebuild&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Recompute from NONE using entry-box parameters&quot;</span><span class="p">),</span>
    <span class="n">rebuild_from_none</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--rebuild-from-none&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Start from entry-box NONE-equivalent and run forward&quot;</span><span class="p">),</span>
    <span class="n">clone_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--clone-only&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Normalize/copy entry-box to H5 without recomputation&quot;</span><span class="p">),</span>
    <span class="n">info</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">typer</span><span class="o">.</span><span class="n">Option</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;--info&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Show resolved defaults and exit&quot;</span><span class="p">),</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">cfg</span> <span class="o">=</span> <span class="n">Fov2BoxConfig</span><span class="p">(</span>
        <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="n">coords</span><span class="p">,</span>
        <span class="n">hpc</span><span class="o">=</span><span class="n">hpc</span><span class="p">,</span>
        <span class="n">hgc</span><span class="o">=</span><span class="n">hgc</span><span class="p">,</span>
        <span class="n">hgs</span><span class="o">=</span><span class="n">hgs</span><span class="p">,</span>
        <span class="n">cea</span><span class="o">=</span><span class="n">cea</span><span class="p">,</span>
        <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
        <span class="n">box_dims</span><span class="o">=</span><span class="n">box_dims</span><span class="p">,</span>
        <span class="n">dx_km</span><span class="o">=</span><span class="n">dx_km</span><span class="p">,</span>
        <span class="n">pad_frac</span><span class="o">=</span><span class="n">pad_frac</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="n">gxmodel_dir</span><span class="o">=</span><span class="n">gxmodel_dir</span><span class="p">,</span>
        <span class="n">entry_box</span><span class="o">=</span><span class="n">entry_box</span><span class="p">,</span>
        <span class="n">save_empty_box</span><span class="o">=</span><span class="n">save_empty_box</span><span class="p">,</span>
        <span class="n">save_potential</span><span class="o">=</span><span class="n">save_potential</span><span class="p">,</span>
        <span class="n">save_bounds</span><span class="o">=</span><span class="n">save_bounds</span><span class="p">,</span>
        <span class="n">save_nas</span><span class="o">=</span><span class="n">save_nas</span><span class="p">,</span>
        <span class="n">save_gen</span><span class="o">=</span><span class="n">save_gen</span><span class="p">,</span>
        <span class="n">save_chr</span><span class="o">=</span><span class="n">save_chr</span><span class="p">,</span>
        <span class="n">stop_after</span><span class="o">=</span><span class="n">stop_after</span><span class="p">,</span>
        <span class="n">empty_box_only</span><span class="o">=</span><span class="n">empty_box_only</span><span class="p">,</span>
        <span class="n">potential_only</span><span class="o">=</span><span class="n">potential_only</span><span class="p">,</span>
        <span class="n">nlfff_only</span><span class="o">=</span><span class="n">nlfff_only</span><span class="p">,</span>
        <span class="n">generic_only</span><span class="o">=</span><span class="n">generic_only</span><span class="p">,</span>
        <span class="n">use_potential</span><span class="o">=</span><span class="n">use_potential</span><span class="p">,</span>
        <span class="n">skip_lines</span><span class="o">=</span><span class="n">skip_lines</span><span class="p">,</span>
        <span class="n">center_vox</span><span class="o">=</span><span class="n">center_vox</span><span class="p">,</span>
        <span class="n">reduce_passed</span><span class="o">=</span><span class="n">reduce_passed</span><span class="p">,</span>
        <span class="n">euv</span><span class="o">=</span><span class="n">euv</span><span class="p">,</span>
        <span class="n">uv</span><span class="o">=</span><span class="n">uv</span><span class="p">,</span>
        <span class="n">sfq</span><span class="o">=</span><span class="n">sfq</span><span class="p">,</span>
        <span class="n">jump2potential</span><span class="o">=</span><span class="n">jump2potential</span><span class="p">,</span>
        <span class="n">jump2bounds</span><span class="o">=</span><span class="n">jump2bounds</span><span class="p">,</span>
        <span class="n">jump2nlfff</span><span class="o">=</span><span class="n">jump2nlfff</span><span class="p">,</span>
        <span class="n">jump2lines</span><span class="o">=</span><span class="n">jump2lines</span><span class="p">,</span>
        <span class="n">jump2chromo</span><span class="o">=</span><span class="n">jump2chromo</span><span class="p">,</span>
        <span class="n">rebuild</span><span class="o">=</span><span class="n">rebuild</span><span class="p">,</span>
        <span class="n">rebuild_from_none</span><span class="o">=</span><span class="n">rebuild_from_none</span><span class="p">,</span>
        <span class="n">clone_only</span><span class="o">=</span><span class="n">clone_only</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgs</span><span class="p">]):</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">cea</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Select only one projection: --cea or --top&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">cea</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">:</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">cea</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">legacy_stop_flags</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">empty_box_only</span><span class="p">,</span> <span class="s2">&quot;--empty-box-only&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;pot&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">potential_only</span><span class="p">,</span> <span class="s2">&quot;--potential-only&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;nas&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nlfff_only</span><span class="p">,</span> <span class="s2">&quot;--nlfff-only&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;gen&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">generic_only</span><span class="p">,</span> <span class="s2">&quot;--generic-only&quot;</span><span class="p">),</span>
    <span class="p">]</span>
    <span class="n">active_legacy</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">legacy_stop_flags</span> <span class="k">if</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">active_legacy</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">active_legacy</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Conflicting legacy stop flags: </span><span class="si">{</span><span class="n">names</span><span class="si">}</span><span class="s2">. Use only one or use --stop-after.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">active_legacy</span><span class="p">:</span>
        <span class="n">legacy_stop</span> <span class="o">=</span> <span class="n">active_legacy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">!=</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">legacy_stop</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Conflicting stop controls: --stop-after=</span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="n">active_legacy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">or</span> <span class="n">legacy_stop</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
        <span class="n">_print_info</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone_only</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--clone-only requires --entry-box&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone_only</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--clone-only cannot be combined with --rebuild or --rebuild-from-none&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--rebuild-from-none requires --entry-box&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Use only one of --rebuild or --rebuild-from-none&quot;</span><span class="p">)</span>

    <span class="n">jump_flags_set</span> <span class="o">=</span> <span class="nb">any</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">jump2potential</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2bounds</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2nlfff</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2lines</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2chromo</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">jump_flags_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: jump2* flags are ignored unless --entry-box is provided.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span> <span class="ow">and</span> <span class="n">jump_flags_set</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--rebuild-from-none cannot be combined with jump2* flags&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_potential</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">jump2nlfff</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">jump2bounds</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--use-potential cannot be combined with --jump2nlfff or --jump2bounds&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">skip_lines</span> <span class="ow">and</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--skip-lines cannot be combined with stop-after GEN (or equivalent).&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">skip_lines</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">center_vox</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: --center-vox is ignored when --skip-lines is set.&quot;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">center_vox</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">entry_loaded</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entry_stage</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">target_stage</span> <span class="o">=</span> <span class="s2">&quot;NONE&quot;</span>
    <span class="n">data_dir_explicit</span> <span class="o">=</span> <span class="n">_flag_explicit_on_cli</span><span class="p">(</span><span class="s2">&quot;--data-dir&quot;</span><span class="p">)</span>
    <span class="n">gxmodel_dir_explicit</span> <span class="o">=</span> <span class="n">_flag_explicit_on_cli</span><span class="p">(</span><span class="s2">&quot;--gxmodel-dir&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
        <span class="n">entry_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--entry-box not found: </span><span class="si">{</span><span class="n">entry_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">entry_loaded</span> <span class="o">=</span> <span class="n">_load_entry_box_any</span><span class="p">(</span><span class="n">entry_path</span><span class="p">)</span>
        <span class="n">entry_stage</span> <span class="o">=</span> <span class="n">_entry_stage_from_loaded</span><span class="p">(</span><span class="n">entry_loaded</span><span class="p">,</span> <span class="n">entry_path</span><span class="p">)</span>
        <span class="n">execute_text</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">exec_data_dir</span><span class="p">,</span> <span class="n">exec_gxmodel_dir</span> <span class="o">=</span> <span class="n">_extract_execute_paths</span><span class="p">(</span><span class="n">execute_text</span><span class="p">)</span>
        <span class="n">exec_coords</span><span class="p">,</span> <span class="n">exec_frame</span><span class="p">,</span> <span class="n">exec_projection</span> <span class="o">=</span> <span class="n">_extract_execute_geometry</span><span class="p">(</span><span class="n">execute_text</span><span class="p">)</span>
        <span class="n">frame_explicit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="n">_flag_explicit_on_cli</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;--hgc&quot;</span><span class="p">,</span> <span class="s2">&quot;--hgs&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">proj_explicit</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">_flag_explicit_on_cli</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="k">for</span> <span class="n">flag</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;--cea&quot;</span><span class="p">,</span> <span class="s2">&quot;--top&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">exec_data_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data_dir_explicit</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">exec_data_dir</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using --data-dir from entry metadata/execute: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_warn_path_default</span><span class="p">(</span><span class="s2">&quot;data_dir&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exec_gxmodel_dir</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">gxmodel_dir_explicit</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span> <span class="o">=</span> <span class="n">exec_gxmodel_dir</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using --gxmodel-dir from entry metadata/execute: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">_warn_path_default</span><span class="p">(</span><span class="s2">&quot;gxmodel_dir&quot;</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">exec_coords</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span> <span class="o">=</span> <span class="n">exec_coords</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using --coords from entry metadata/execute: </span><span class="si">{</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">frame_explicit</span> <span class="ow">and</span> <span class="n">exec_frame</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;hpc&quot;</span><span class="p">,</span> <span class="s2">&quot;hgc&quot;</span><span class="p">,</span> <span class="s2">&quot;hgs&quot;</span><span class="p">):</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span> <span class="o">=</span> <span class="n">exec_frame</span> <span class="o">==</span> <span class="s2">&quot;hpc&quot;</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">hgc</span> <span class="o">=</span> <span class="n">exec_frame</span> <span class="o">==</span> <span class="s2">&quot;hgc&quot;</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">hgs</span> <span class="o">=</span> <span class="n">exec_frame</span> <span class="o">==</span> <span class="s2">&quot;hgs&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">proj_explicit</span> <span class="ow">and</span> <span class="n">exec_projection</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;cea&quot;</span><span class="p">,</span> <span class="s2">&quot;top&quot;</span><span class="p">):</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">cea</span> <span class="o">=</span> <span class="n">exec_projection</span> <span class="o">==</span> <span class="s2">&quot;cea&quot;</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">exec_projection</span> <span class="o">==</span> <span class="s2">&quot;top&quot;</span>
    <span class="n">target_stage</span> <span class="o">=</span> <span class="n">_detect_target_stage</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">entry_stage</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild_from_none</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">entry_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_jump_allowed</span><span class="p">(</span><span class="n">entry_stage</span><span class="p">,</span> <span class="n">target_stage</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Incompatible jump request: entry stage </span><span class="si">{</span><span class="n">entry_stage</span><span class="si">}</span><span class="s2"> cannot jump to </span><span class="si">{</span><span class="n">target_stage</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Allowed: backward jumps, forward by one stage, NONE-&gt;BND (implicit POT), POT-&gt;NAS (implicit BND), and POT-&gt;GEN.&quot;</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">clone_only</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">entry_loaded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">assert</span> <span class="n">entry_stage</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">jump_flags_set</span> <span class="ow">and</span> <span class="n">target_stage</span> <span class="o">!=</span> <span class="n">entry_stage</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;--clone-only allows only no jump or jump-to-self; got entry </span><span class="si">{</span><span class="n">entry_stage</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">target_stage</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Prefer inferred time from entry path/id for output folder naming.</span>
        <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">time</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">obs_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">:</span>
            <span class="n">inferred</span> <span class="o">=</span> <span class="n">_infer_time_from_path</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">inferred</span><span class="p">:</span>
                <span class="n">obs_time</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">inferred</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obs_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--clone-only requires --time or inferable time from --entry-box filename.&quot;</span><span class="p">)</span>

        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">_stage_output_dir</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="p">,</span> <span class="n">obs_time</span><span class="p">)</span>
        <span class="n">src_id</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">inferred_tag</span> <span class="o">=</span> <span class="n">_split_stage_id</span><span class="p">(</span><span class="n">src_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">src_id</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">stage_tag</span> <span class="o">=</span> <span class="n">inferred_tag</span> <span class="ow">or</span> <span class="n">_stage_tag_from_stage</span><span class="p">(</span><span class="n">entry_stage</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">src_id</span><span class="p">:</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">src_id</span><span class="si">}</span><span class="s2">.h5&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">_stage_file_base</span><span class="p">(</span><span class="n">obs_time</span><span class="p">,</span> <span class="s2">&quot;CLONE&quot;</span><span class="p">,</span> <span class="n">projection_tag</span><span class="o">=</span><span class="s2">&quot;CEA&quot;</span><span class="p">)</span>
            <span class="n">out_path</span> <span class="o">=</span> <span class="n">_stage_filename</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">)</span>

        <span class="n">clone_box</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entry_loaded</span><span class="p">)</span>
        <span class="n">meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">clone_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;execute&quot;</span><span class="p">,</span> <span class="n">_build_execute_cmd</span><span class="p">(</span><span class="n">cfg</span><span class="p">))</span>
        <span class="n">meta</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">out_path</span><span class="o">.</span><span class="n">stem</span><span class="p">)</span>
        <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;clone_only&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
        <span class="n">clone_box</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
        <span class="n">clone_box</span> <span class="o">=</span> <span class="n">_normalize_stage_for_h5</span><span class="p">(</span><span class="n">clone_box</span><span class="p">)</span>
        <span class="n">write_b3d_h5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">clone_box</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Completed gx-fov2box clone-only. Output file:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">time_mod</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

    <span class="n">t_start</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;.*assume_spherical_screen.*&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;reproject&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;sunpy&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

    <span class="n">obs_time</span><span class="p">,</span> <span class="n">box_dims_resolved</span><span class="p">,</span> <span class="n">dx_km</span> <span class="o">=</span> <span class="n">_resolve_box_params</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span> <span class="o">=</span> <span class="n">dx_km</span>
    <span class="n">resume_mode</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span> <span class="ow">and</span> <span class="n">entry_loaded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">resume_mode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--coords is required&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgc</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgs</span><span class="p">])</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Select exactly one of --hpc, --hgc, --hgs&quot;</span><span class="p">)</span>

    <span class="n">_warn_impossible_save_requests</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">target_stage</span><span class="p">)</span>
    <span class="n">stage_rank</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NONE&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&quot;CHR&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span>
    <span class="n">start_rank</span> <span class="o">=</span> <span class="n">stage_rank</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">target_stage</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">maps</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_bz_arr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">base_ic_arr</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bottom_bz_data</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vert_current_error</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">projection_tag</span> <span class="o">=</span> <span class="s2">&quot;CEA&quot;</span>
    <span class="n">base</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">dr3</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">resume_mode</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">entry_loaded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">base_group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">base_group</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bx&quot;</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Entry-box resume requires base/bx, base/by, and base/bz.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;ic&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_group</span><span class="p">:</span>
            <span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;ic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;chromo_mask&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">base_group</span><span class="p">:</span>
            <span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;chromo_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">decompose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                                                  <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;ic&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">refmaps</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;refmaps&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">base_bz_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">base_ic_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;ic&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">bottom_bz_data</span> <span class="o">=</span> <span class="n">base_bz_arr</span>
        <span class="n">projection_tag</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;projection&quot;</span><span class="p">,</span> <span class="s2">&quot;CEA&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>

        <span class="n">axis_order</span> <span class="o">=</span> <span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;axis_order_3d&quot;</span><span class="p">)</span>
        <span class="n">entry_corona_for_dr</span> <span class="o">=</span> <span class="n">_h5_corona_to_internal_xyz</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corona&quot;</span><span class="p">),</span> <span class="n">axis_order</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry_corona_for_dr</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;dr&quot;</span> <span class="ow">in</span> <span class="n">entry_corona_for_dr</span><span class="p">:</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">entry_corona_for_dr</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">dr3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)],</span> <span class="n">d</span><span class="p">[</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">sun_consts</span><span class="o">.</span><span class="n">radius</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">))</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">dr3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">dr</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dr</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">src_id</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">src_id</span><span class="p">:</span>
            <span class="n">base</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_stage_id</span><span class="p">(</span><span class="n">src_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">base</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span> <span class="k">else</span> <span class="n">_stage_file_base</span><span class="p">(</span><span class="n">obs_time</span><span class="p">,</span> <span class="s2">&quot;UNKNOWN&quot;</span><span class="p">,</span> <span class="n">projection_tag</span><span class="o">=</span><span class="n">projection_tag</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">observer</span> <span class="o">=</span> <span class="n">get_earth</span><span class="p">(</span><span class="n">obs_time</span><span class="p">)</span>

        <span class="n">data_dir_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">data_dir</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="n">disambig_method</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sfq</span> <span class="k">else</span> <span class="mi">2</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Checking/downloading HMI/AIA data...&quot;</span><span class="p">)</span>
        <span class="n">dl_t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">maps</span><span class="p">,</span> <span class="n">download_info</span> <span class="o">=</span> <span class="n">_load_hmi_maps_from_downloader</span><span class="p">(</span>
            <span class="n">obs_time</span><span class="p">,</span>
            <span class="n">data_dir_path</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">euv</span><span class="p">,</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">uv</span><span class="p">,</span>
            <span class="n">disambig_method</span><span class="o">=</span><span class="n">disambig_method</span><span class="p">,</span>
            <span class="n">strict_required</span><span class="o">=</span><span class="p">(</span><span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;DL&quot;</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">dl_elapsed</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">dl_t0</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done in </span><span class="si">{</span><span class="n">dl_elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;DL&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopped after download stage by request.&quot;</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total elapsed: </span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">rsun</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rsun_meters</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hpc</span><span class="p">:</span>
            <span class="n">box_origin</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span> <span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">,</span>
                                  <span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">rsun</span><span class="o">=</span><span class="n">rsun</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">Helioprojective</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">cfg</span><span class="o">.</span><span class="n">hgc</span><span class="p">:</span>
            <span class="n">box_origin</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                  <span class="n">radius</span><span class="o">=</span><span class="n">rsun</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span>
                                  <span class="n">frame</span><span class="o">=</span><span class="n">HeliographicCarrington</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box_origin</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">,</span>
                                  <span class="n">radius</span><span class="o">=</span><span class="n">rsun</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span> <span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span>
                                  <span class="n">frame</span><span class="o">=</span><span class="n">HeliographicStonyhurst</span><span class="p">)</span>

        <span class="n">box_dims_q</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">Quantity</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">box_dims_resolved</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span>
        <span class="n">box_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Mm</span><span class="p">)</span>

        <span class="n">frame_obs</span> <span class="o">=</span> <span class="n">Helioprojective</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="n">observer</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">,</span> <span class="n">rsun</span><span class="o">=</span><span class="n">rsun</span><span class="p">)</span>
        <span class="n">frame_hcc</span> <span class="o">=</span> <span class="n">Heliocentric</span><span class="p">(</span><span class="n">observer</span><span class="o">=</span><span class="n">box_origin</span><span class="p">,</span> <span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">)</span>
        <span class="n">box_center</span> <span class="o">=</span> <span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">frame_hcc</span><span class="p">)</span>
        <span class="n">center_z</span> <span class="o">=</span> <span class="n">box_center</span><span class="o">.</span><span class="n">z</span> <span class="o">+</span> <span class="p">(</span><span class="n">box_dims_q</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span> <span class="o">*</span> <span class="n">box_res</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">box_center</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">box_center</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">box_center</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">center_z</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">frame_hcc</span><span class="p">)</span>

        <span class="n">box</span> <span class="o">=</span> <span class="n">Box</span><span class="p">(</span><span class="n">frame_obs</span><span class="p">,</span> <span class="n">box_origin</span><span class="p">,</span> <span class="n">box_center</span><span class="p">,</span> <span class="n">box_dims_q</span><span class="p">,</span> <span class="n">box_res</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">top</span><span class="p">:</span>
            <span class="n">bottom_wcs_header</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">bottom_top_header</span><span class="p">(</span><span class="n">dsun_obs</span><span class="o">=</span><span class="n">maps</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dsun</span><span class="p">)</span>
            <span class="n">projection_tag</span> <span class="o">=</span> <span class="s2">&quot;TOP&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bottom_wcs_header</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">bottom_cea_header</span>
            <span class="n">projection_tag</span> <span class="o">=</span> <span class="s2">&quot;CEA&quot;</span>
        <span class="n">fov_coords</span> <span class="o">=</span> <span class="n">box</span><span class="o">.</span><span class="n">bounds_coords_bl_tr</span><span class="p">(</span><span class="n">pad_frac</span><span class="o">=</span><span class="n">cfg</span><span class="o">.</span><span class="n">pad_frac</span><span class="p">)</span>

        <span class="n">map_bp</span><span class="p">,</span> <span class="n">map_bt</span><span class="p">,</span> <span class="n">map_br</span> <span class="o">=</span> <span class="n">hmi_b2ptr</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">],</span> <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;inclination&quot;</span><span class="p">],</span> <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;azimuth&quot;</span><span class="p">])</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">submap_with_fov</span><span class="p">(</span><span class="n">_map</span><span class="p">:</span> <span class="n">Map</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="p">:</span>
            <span class="n">bl</span> <span class="o">=</span> <span class="n">fov_coords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">_map</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="p">)</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">fov_coords</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">_map</span><span class="o">.</span><span class="n">coordinate_frame</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_map</span><span class="o">.</span><span class="n">submap</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">top_right</span><span class="o">=</span><span class="n">tr</span><span class="p">)</span>

        <span class="n">map_bp</span> <span class="o">=</span> <span class="n">submap_with_fov</span><span class="p">(</span><span class="n">map_bp</span><span class="p">)</span>
        <span class="n">map_bt</span> <span class="o">=</span> <span class="n">submap_with_fov</span><span class="p">(</span><span class="n">map_bt</span><span class="p">)</span>
        <span class="n">map_br</span> <span class="o">=</span> <span class="n">submap_with_fov</span><span class="p">(</span><span class="n">map_br</span><span class="p">)</span>
        <span class="n">map_cont</span> <span class="o">=</span> <span class="n">submap_with_fov</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="s2">&quot;continuum&quot;</span><span class="p">])</span>
        <span class="n">map_los</span> <span class="o">=</span> <span class="n">submap_with_fov</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">])</span>

        <span class="c1"># Match GX/IDL base convention: bx := bp, by := -bt, bz := br.</span>
        <span class="n">map_bx</span> <span class="o">=</span> <span class="n">map_bp</span>
        <span class="n">map_by</span> <span class="o">=</span> <span class="n">Map</span><span class="p">(</span><span class="o">-</span><span class="n">map_bt</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">map_bt</span><span class="o">.</span><span class="n">meta</span><span class="p">)</span>
        <span class="n">map_bz</span> <span class="o">=</span> <span class="n">map_br</span>

        <span class="n">bottom_bx</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">bottom_by</span> <span class="o">=</span> <span class="n">map_by</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">bottom_bz</span> <span class="o">=</span> <span class="n">map_bz</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>

        <span class="n">base_bz</span> <span class="o">=</span> <span class="n">map_los</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">base_ic</span> <span class="o">=</span> <span class="n">map_cont</span><span class="o">.</span><span class="n">reproject_to</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s2">&quot;exact&quot;</span><span class="p">)</span>
        <span class="n">base_bz_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">base_ic_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_ic</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">bottom_bz_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bottom_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

        <span class="n">index</span> <span class="o">=</span> <span class="n">_build_index_header</span><span class="p">(</span><span class="n">bottom_wcs_header</span><span class="p">,</span> <span class="n">bottom_bz</span><span class="p">)</span>
        <span class="n">chromo_mask</span> <span class="o">=</span> <span class="n">decompose</span><span class="p">(</span><span class="n">base_bz_arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">base_ic_arr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        <span class="n">base_group</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">bottom_bx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">bottom_by</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">bottom_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;ic&quot;</span><span class="p">:</span> <span class="n">base_ic</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;chromo_mask&quot;</span><span class="p">:</span> <span class="n">chromo_mask</span><span class="p">,</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">refmaps</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">add_refmap</span><span class="p">(</span><span class="n">ref_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">smap</span><span class="p">:</span> <span class="n">Map</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">smap</span> <span class="o">=</span> <span class="n">submap_with_fov</span><span class="p">(</span><span class="n">smap</span><span class="p">)</span>
            <span class="c1"># Use WCS header only to avoid non-ASCII FITS meta from some sources.</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">smap</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span>
            <span class="n">refmaps</span><span class="p">[</span><span class="n">ref_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">smap</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;wcs_header&quot;</span><span class="p">:</span> <span class="n">header</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>

        <span class="n">add_refmap</span><span class="p">(</span><span class="s2">&quot;Bz_reference&quot;</span><span class="p">,</span> <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">])</span>
        <span class="n">add_refmap</span><span class="p">(</span><span class="s2">&quot;Ic_reference&quot;</span><span class="p">,</span> <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;continuum&quot;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">vc_header</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">to_header</span><span class="p">()</span><span class="o">.</span><span class="n">tostring</span><span class="p">(</span><span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span><span class="p">,</span> <span class="n">endcard</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rsun_arcsec</span> <span class="o">=</span> <span class="n">maps</span><span class="p">[</span><span class="s2">&quot;magnetogram&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rsun_obs</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span><span class="p">)</span>
            <span class="n">crpix1</span><span class="p">,</span> <span class="n">crpix2</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">crpix</span>
            <span class="n">cdelt1</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">axis1</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
            <span class="n">cdelt2</span> <span class="o">=</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">scale</span><span class="o">.</span><span class="n">axis2</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">arcsec</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">pix</span><span class="p">)</span>
            <span class="n">jz</span> <span class="o">=</span> <span class="n">compute_vertical_current</span><span class="p">(</span><span class="n">map_bz</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">map_bx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">map_by</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">vc_header</span><span class="p">,</span> <span class="n">rsun_arcsec</span><span class="p">,</span>
                                          <span class="n">crpix1</span><span class="o">=</span><span class="n">crpix1</span><span class="p">,</span> <span class="n">crpix2</span><span class="o">=</span><span class="n">crpix2</span><span class="p">,</span>
                                          <span class="n">cdelt1_arcsec</span><span class="o">=</span><span class="n">cdelt1</span><span class="p">,</span> <span class="n">cdelt2_arcsec</span><span class="o">=</span><span class="n">cdelt2</span><span class="p">)</span>
            <span class="n">refmaps</span><span class="p">[</span><span class="s2">&quot;Vert_current&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">jz</span><span class="p">,</span> <span class="s2">&quot;wcs_header&quot;</span><span class="p">:</span> <span class="n">vc_header</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="n">vert_current_error</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">pb</span> <span class="ow">in</span> <span class="n">AIA_EUV_PASSBANDS</span> <span class="o">+</span> <span class="n">AIA_UV_PASSBANDS</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;AIA_</span><span class="si">{</span><span class="n">pb</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">maps</span><span class="p">:</span>
                <span class="n">add_refmap</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">maps</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>

        <span class="n">obs_dr</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">dx_km</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="p">)</span> <span class="o">/</span> <span class="n">rsun</span>
        <span class="n">dr3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obs_dr</span><span class="o">.</span><span class="n">value</span><span class="p">])</span>
        <span class="n">coord_tag</span> <span class="o">=</span> <span class="n">_format_coord_tag</span><span class="p">(</span>
            <span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicCarrington</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">))</span><span class="o">.</span><span class="n">lon</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
            <span class="n">box_origin</span><span class="o">.</span><span class="n">transform_to</span><span class="p">(</span><span class="n">HeliographicCarrington</span><span class="p">(</span><span class="n">obstime</span><span class="o">=</span><span class="n">obs_time</span><span class="p">))</span><span class="o">.</span><span class="n">lat</span><span class="o">.</span><span class="n">to_value</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">deg</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">base</span> <span class="o">=</span> <span class="n">_stage_file_base</span><span class="p">(</span><span class="n">obs_time</span><span class="p">,</span> <span class="n">coord_tag</span><span class="p">,</span> <span class="n">projection_tag</span><span class="o">=</span><span class="n">projection_tag</span><span class="p">)</span>

    <span class="n">empty_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">default_grid</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dx&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">dr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;dy&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">dr3</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="s2">&quot;dz&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">dr3</span><span class="p">[</span><span class="mi">2</span><span class="p">])],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)}</span>

    <span class="n">out_dir</span> <span class="o">=</span> <span class="n">_stage_output_dir</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">gxmodel_dir</span><span class="p">,</span> <span class="n">obs_time</span><span class="p">)</span>
    <span class="n">execute_cmd</span> <span class="o">=</span> <span class="n">_build_execute_cmd</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>
    <span class="n">lineage_marker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">entry_stage_for_marker</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">resume_mode</span> <span class="ow">and</span> <span class="n">entry_loaded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entry_meta</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{}))</span>
        <span class="n">lineage_root</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">entry_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lineage&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">lineage_root</span><span class="p">:</span>
            <span class="n">entry_id</span> <span class="o">=</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">entry_meta</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">entry_stage_tag</span> <span class="o">=</span> <span class="n">_split_stage_id</span><span class="p">(</span><span class="n">entry_id</span><span class="p">)</span> <span class="k">if</span> <span class="n">entry_id</span> <span class="k">else</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">entry_stage_for_marker</span> <span class="o">=</span> <span class="n">entry_stage_tag</span> <span class="ow">or</span> <span class="n">_stage_tag_from_stage</span><span class="p">(</span><span class="n">entry_stage</span> <span class="ow">or</span> <span class="n">target_stage</span><span class="p">)</span>
            <span class="n">entry_fmt</span> <span class="o">=</span> <span class="s2">&quot;SAV&quot;</span> <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.sav&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;H5&quot;</span>
            <span class="n">lineage_marker</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ENTRY.</span><span class="si">{</span><span class="n">entry_stage_for_marker</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">entry_fmt</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">lineage_root</span> <span class="o">=</span> <span class="n">lineage_marker</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lineage_root</span> <span class="o">=</span> <span class="s2">&quot;OBS&quot;</span>

    <span class="n">produced</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">stage_times</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">finalize</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">produced</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Completed gx-fov2box. Output files:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">produced</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stage_times</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stage timings:&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">stage</span><span class="p">,</span> <span class="n">seconds</span> <span class="ow">in</span> <span class="n">stage_times</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;- </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">seconds</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>
        <span class="n">total</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t_start</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total elapsed: </span><span class="si">{</span><span class="n">total</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save_stage</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">stage_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_should_save_stage</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">,</span> <span class="n">cfg</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">stage_box</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;base&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_group</span>
        <span class="k">if</span> <span class="s2">&quot;refmaps&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;refmaps&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">refmaps</span>
        <span class="k">if</span> <span class="s2">&quot;corona&quot;</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">corona</span> <span class="o">=</span> <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;dr&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">corona</span><span class="p">:</span>
                <span class="n">corona</span><span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dr3</span>
            <span class="n">voxel_id</span><span class="p">,</span> <span class="n">corona_base</span> <span class="o">=</span> <span class="n">gx_box2id</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">corona</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">stage_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">),</span> <span class="s2">&quot;chromo&quot;</span><span class="p">:</span> <span class="n">stage_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromo&quot;</span><span class="p">)},</span>
                <span class="n">return_corona_base</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">corona_base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">corona</span><span class="p">[</span><span class="s2">&quot;corona_base&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">corona_base</span><span class="p">)</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;corona&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">corona</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">default_grid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">voxel_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">grid</span><span class="p">[</span><span class="s2">&quot;voxel_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">voxel_id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">grid</span><span class="p">[</span><span class="s2">&quot;voxel_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gx_box2id</span><span class="p">({</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">empty_grid</span><span class="p">,</span> <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">empty_grid</span><span class="p">,</span> <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">empty_grid</span><span class="p">,</span> <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">dr3</span><span class="p">}})</span>
            <span class="k">if</span> <span class="s2">&quot;chromo&quot;</span> <span class="ow">in</span> <span class="n">stage_box</span> <span class="ow">and</span> <span class="s2">&quot;dz&quot;</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">]:</span>
                <span class="n">grid</span><span class="p">[</span><span class="s2">&quot;dz&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;chromo&quot;</span><span class="p">][</span><span class="s2">&quot;dz&quot;</span><span class="p">]</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="k">elif</span> <span class="s2">&quot;grid&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stage_box</span><span class="p">:</span>
            <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_grid</span>
        <span class="n">stage_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">stage_tag</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">lineage_suffix</span> <span class="o">=</span> <span class="n">_canonical_lineage_suffix</span><span class="p">(</span><span class="n">stage_tag</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;execute&quot;</span><span class="p">:</span> <span class="n">execute_cmd</span><span class="p">,</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">stage_id</span><span class="p">,</span>
            <span class="s2">&quot;lineage&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">lineage_marker</span><span class="si">}</span><span class="s2">-&gt;</span><span class="si">{</span><span class="n">_lineage_delta_from_entry</span><span class="p">(</span><span class="n">entry_stage_for_marker</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">stage_tag</span><span class="p">,</span><span class="w"> </span><span class="n">stage_tag</span><span class="p">)</span><span class="si">}</span><span class="s2">.h5&quot;</span>
                <span class="k">if</span> <span class="n">lineage_marker</span>
                <span class="k">else</span> <span class="n">_merge_lineage</span><span class="p">(</span><span class="n">lineage_root</span><span class="p">,</span> <span class="n">lineage_suffix</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="s2">&quot;disambiguation&quot;</span><span class="p">:</span> <span class="s2">&quot;SFQ&quot;</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">sfq</span> <span class="k">else</span> <span class="s2">&quot;HMI&quot;</span><span class="p">,</span>
            <span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="n">_decode_id_text</span><span class="p">(</span><span class="n">projection_tag</span><span class="p">)</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span>
            <span class="s2">&quot;axis_order_2d&quot;</span><span class="p">:</span> <span class="s2">&quot;yx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;axis_order_3d&quot;</span><span class="p">:</span> <span class="s2">&quot;zyx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;vector_layout&quot;</span><span class="p">:</span> <span class="s2">&quot;split_components&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">vert_current_error</span><span class="p">:</span>
            <span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;vert_current_error&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vert_current_error</span>
        <span class="n">stage_box</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="n">_normalize_stage_for_h5</span><span class="p">(</span><span class="n">stage_box</span><span class="p">)</span>
        <span class="n">out_path</span> <span class="o">=</span> <span class="n">_stage_filename</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">stage_tag</span><span class="p">)</span>
        <span class="n">write_b3d_h5</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="n">stage_box</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved </span><span class="si">{</span><span class="n">stage_tag</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">produced</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">start_rank</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">save_empty_box</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">empty_box_only</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;none&quot;</span><span class="p">,</span> <span class="s2">&quot;empty&quot;</span><span class="p">,</span> <span class="s2">&quot;empty_box&quot;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing NONE model...&quot;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="c1"># NONE stage should preserve boundary conditions at z=0 and keep z&gt;0 empty.</span>
        <span class="c1"># Canonical 3D order in H5 is (nz, ny, nx).</span>
        <span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span> <span class="o">=</span> <span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">corona_bx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">corona_by</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">corona_bz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nz</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">corona_bx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">corona_by</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">corona_bz</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">stage_box</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">corona_bx</span><span class="p">,</span>
                <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">corona_by</span><span class="p">,</span>
                <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">corona_bz</span><span class="p">,</span>
                <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">dr3</span><span class="p">,</span>
                <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">},</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;NONE&quot;</span><span class="p">,</span> <span class="n">stage_box</span><span class="p">)</span>
        <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;NONE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">empty_box_only</span> <span class="ow">or</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NONE&quot;</span><span class="p">:</span>
            <span class="n">finalize</span><span class="p">()</span>
            <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_pot_box</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">bnddata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">bottom_bz_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">bnddata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bnddata</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">maglib_lff</span> <span class="o">=</span> <span class="n">MagFieldLinFFF</span><span class="p">()</span>
        <span class="n">maglib_lff</span><span class="o">.</span><span class="n">set_field</span><span class="p">(</span><span class="n">bnddata</span><span class="p">)</span>
        <span class="n">pot_res</span> <span class="o">=</span> <span class="n">maglib_lff</span><span class="o">.</span><span class="n">LFFF_cube</span><span class="p">(</span><span class="n">nz</span><span class="o">=</span><span class="n">box_dims_resolved</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">pot_res</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">pot_res</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">pot_res</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">dr3</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pot&quot;</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_make_bnd_from_pot</span><span class="p">(</span><span class="n">pot_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">bnd</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">dr3</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bnd&quot;</span><span class="p">},</span>
        <span class="p">}</span>
        <span class="c1"># Internal cube layout is (x, y, z); overwrite the z=0 boundary with observed base vectors.</span>
        <span class="n">bnd</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">bnd</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">bnd</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">][:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">base_group</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">return</span> <span class="n">bnd</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_run_nlfff_from_bnd</span><span class="p">(</span><span class="n">bnd_box</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">maglib</span> <span class="o">=</span> <span class="n">MagFieldProcessor</span><span class="p">()</span>
        <span class="n">maglib</span><span class="o">.</span><span class="n">load_cube_vars</span><span class="p">({</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">bnd_box</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">bnd_box</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">bnd_box</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="n">res_nlf</span> <span class="o">=</span> <span class="n">maglib</span><span class="o">.</span><span class="n">NLFFF</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">res_nlf</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">res_nlf</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">res_nlf</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">dr3</span><span class="p">,</span>
            <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">},</span>
        <span class="p">}</span>

    <span class="n">active_jump</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">entry_box</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">rebuild</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
            <span class="n">active_jump</span> <span class="o">=</span> <span class="s2">&quot;potential&quot;</span>
        <span class="k">elif</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
            <span class="n">active_jump</span> <span class="o">=</span> <span class="s2">&quot;bounds&quot;</span>
        <span class="k">elif</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span>
            <span class="n">active_jump</span> <span class="o">=</span> <span class="s2">&quot;nlfff&quot;</span>
        <span class="k">elif</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span>
            <span class="n">active_jump</span> <span class="o">=</span> <span class="s2">&quot;lines&quot;</span>
        <span class="k">elif</span> <span class="n">target_stage</span> <span class="o">==</span> <span class="s2">&quot;CHR&quot;</span><span class="p">:</span>
            <span class="n">active_jump</span> <span class="o">=</span> <span class="s2">&quot;chromo&quot;</span>

    <span class="n">entry_corona</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entry_model</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entry_lines</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">entry_axis_order</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">active_jump</span> <span class="ow">and</span> <span class="n">entry_loaded</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">entry_axis_order</span> <span class="o">=</span> <span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;axis_order_3d&quot;</span><span class="p">)</span>
        <span class="n">entry_corona</span> <span class="o">=</span> <span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;corona&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry_corona</span><span class="p">:</span>
            <span class="n">entry_corona</span> <span class="o">=</span> <span class="n">_h5_corona_to_internal_xyz</span><span class="p">(</span><span class="n">entry_corona</span><span class="p">,</span> <span class="n">entry_axis_order</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry_corona</span><span class="p">:</span>
            <span class="n">entry_model</span> <span class="o">=</span> <span class="n">entry_corona</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">)</span>
        <span class="n">entry_lines</span> <span class="o">=</span> <span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entry_lines</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Backward compatibility with legacy GEN files that stored line keys under chromo.</span>
            <span class="n">entry_lines</span> <span class="o">=</span> <span class="n">entry_loaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chromo&quot;</span><span class="p">)</span>

    <span class="n">goto_lines</span> <span class="o">=</span> <span class="n">active_jump</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="s2">&quot;chromo&quot;</span><span class="p">)</span>
    <span class="n">goto_chromo</span> <span class="o">=</span> <span class="n">active_jump</span> <span class="o">==</span> <span class="s2">&quot;chromo&quot;</span> <span class="ow">or</span> <span class="n">cfg</span><span class="o">.</span><span class="n">skip_lines</span>

    <span class="k">if</span> <span class="n">goto_lines</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_corona</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--jump2lines/--jump2chromo requires --entry-box with corona model_type=pot|nlfff&quot;</span><span class="p">)</span>
        <span class="n">nlfff_box</span> <span class="o">=</span> <span class="n">entry_corona</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">goto_lines</span><span class="p">:</span>
        <span class="n">pot_box</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">bnd_box</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">active_jump</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;potential&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">,</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry_corona</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;--entry-box does not contain corona vectors required by selected jump/recompute action.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">active_jump</span> <span class="o">==</span> <span class="s2">&quot;potential&quot;</span><span class="p">:</span>
                <span class="n">pot_box</span> <span class="o">=</span> <span class="n">entry_corona</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">pot_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;pot&quot;</span><span class="p">:</span>
                    <span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pot&quot;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">active_jump</span> <span class="o">==</span> <span class="s2">&quot;bounds&quot;</span><span class="p">:</span>
                <span class="n">bnd_box</span> <span class="o">=</span> <span class="n">entry_corona</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">bnd_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;bnd&quot;</span><span class="p">,</span> <span class="s2">&quot;bounds&quot;</span><span class="p">):</span>
                    <span class="n">bnd_box</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bnd&quot;</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">active_jump</span> <span class="o">==</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">:</span>
                <span class="c1"># Target NAS can start from POT/BND/NAS entry cubes.</span>
                <span class="k">if</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
                    <span class="n">pot_box</span> <span class="o">=</span> <span class="n">entry_corona</span>
                    <span class="n">bnd_box</span> <span class="o">=</span> <span class="n">_make_bnd_from_pot</span><span class="p">(</span><span class="n">pot_box</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
                    <span class="n">bnd_box</span> <span class="o">=</span> <span class="n">entry_corona</span>
                <span class="k">elif</span> <span class="n">entry_stage</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;NAS&quot;</span><span class="p">,</span> <span class="s2">&quot;GEN&quot;</span><span class="p">,</span> <span class="s2">&quot;CHR&quot;</span><span class="p">):</span>
                    <span class="n">nlfff_box</span> <span class="o">=</span> <span class="n">entry_corona</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">nlfff_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">:</span>
                        <span class="n">nlfff_box</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported entry stage for --jump2nlfff path: </span><span class="si">{</span><span class="n">entry_stage</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pot_box</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">bnd_box</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;nlfff_box&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing POT model...&quot;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">pot_box</span> <span class="o">=</span> <span class="n">_make_pot_box</span><span class="p">()</span>
            <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;POT&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">pot_box</span><span class="p">})</span>
            <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;POT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">potential_only</span> <span class="ow">or</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
                <span class="n">finalize</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">pot_box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing POT model from entry data...&quot;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;POT&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">pot_box</span><span class="p">})</span>
            <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;POT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">potential_only</span> <span class="ow">or</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span><span class="p">:</span>
                <span class="n">finalize</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="n">bnd_box</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pot_box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_potential</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing BND model...&quot;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">bnd_box</span> <span class="o">=</span> <span class="n">_make_bnd_from_pot</span><span class="p">(</span><span class="n">pot_box</span><span class="p">)</span>
            <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;BND&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">bnd_box</span><span class="p">})</span>
            <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;BND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
                <span class="n">finalize</span><span class="p">()</span>
                <span class="k">return</span>
        <span class="k">elif</span> <span class="n">bnd_box</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing BND model from entry data...&quot;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;BND&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">bnd_box</span><span class="p">})</span>
            <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;BND&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;BND&quot;</span><span class="p">:</span>
                <span class="n">finalize</span><span class="p">()</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;nlfff_box&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">use_potential</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">pot_box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pot_box</span> <span class="o">=</span> <span class="n">_make_pot_box</span><span class="p">()</span>
                <span class="n">nlfff_box</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pot_box</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                    <span class="s2">&quot;dr&quot;</span><span class="p">:</span> <span class="n">dr3</span><span class="p">,</span>
                    <span class="s2">&quot;attrs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;model_type&quot;</span><span class="p">:</span> <span class="s2">&quot;pot&quot;</span><span class="p">},</span>
                <span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">bnd_box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">pot_box</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">pot_box</span> <span class="o">=</span> <span class="n">_make_pot_box</span><span class="p">()</span>
                    <span class="n">bnd_box</span> <span class="o">=</span> <span class="n">_make_bnd_from_pot</span><span class="p">(</span><span class="n">pot_box</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Computing NAS model...&quot;</span><span class="p">)</span>
                <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="n">nlfff_box</span> <span class="o">=</span> <span class="n">_run_nlfff_from_bnd</span><span class="p">(</span><span class="n">bnd_box</span><span class="p">)</span>
                <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;NAS&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">})</span>
                <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;NAS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
                <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nlfff_only</span> <span class="ow">or</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span>
                    <span class="n">finalize</span><span class="p">()</span>
                    <span class="k">return</span>
        <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">nlfff_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;nlfff&quot;</span><span class="p">:</span>
            <span class="c1"># Jumped to NAS from an existing NAS/GEN/CHR entry box.</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Preparing NAS model from entry data...&quot;</span><span class="p">)</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            <span class="n">save_stage</span><span class="p">(</span><span class="s2">&quot;NAS&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">})</span>
            <span class="n">stage_times</span><span class="p">[</span><span class="s2">&quot;NAS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">nlfff_only</span> <span class="ow">or</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;NAS&quot;</span><span class="p">:</span>
                <span class="n">finalize</span><span class="p">()</span>
                <span class="k">return</span>

    <span class="n">stage_prefix</span> <span class="o">=</span> <span class="s2">&quot;NAS&quot;</span>
    <span class="n">is_pot_skip_path</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">resume_mode</span>
        <span class="ow">and</span> <span class="n">entry_stage</span> <span class="o">==</span> <span class="s2">&quot;POT&quot;</span>
        <span class="ow">and</span> <span class="n">target_stage</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;GEN&quot;</span><span class="p">,</span> <span class="s2">&quot;CHR&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">nlfff_box</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;attrs&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model_type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;pot&quot;</span> <span class="ow">or</span> <span class="n">is_pot_skip_path</span><span class="p">:</span>
        <span class="n">stage_prefix</span> <span class="o">=</span> <span class="s2">&quot;POT&quot;</span>
    <span class="n">gen_stage_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_prefix</span><span class="si">}</span><span class="s2">.GEN&quot;</span>
    <span class="n">chr_stage_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_prefix</span><span class="si">}</span><span class="s2">.CHR&quot;</span>

    <span class="k">if</span> <span class="n">goto_chromo</span><span class="p">:</span>
        <span class="n">required_line_keys</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;codes&quot;</span><span class="p">,</span> <span class="s2">&quot;apex_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;start_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;end_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;seed_idx&quot;</span><span class="p">,</span>
            <span class="s2">&quot;av_field&quot;</span><span class="p">,</span> <span class="s2">&quot;phys_length&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel_status&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">entry_lines</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">entry_lines</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">required_line_keys</span><span class="p">):</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">entry_lines</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Direct CHR jump without GEN metadata: produce chromo-only augmentation.</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">compute_lines_time</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">skip_lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping GEN line computation by request...&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing </span><span class="si">{</span><span class="n">gen_stage_tag</span><span class="si">}</span><span class="s2"> model...&quot;</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">maglib</span> <span class="o">=</span> <span class="n">MagFieldProcessor</span><span class="p">()</span>
        <span class="n">maglib</span><span class="o">.</span><span class="n">load_cube_vars</span><span class="p">({</span>
            <span class="s2">&quot;bx&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">[</span><span class="s2">&quot;by&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;by&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">[</span><span class="s2">&quot;bx&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;bz&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">[</span><span class="s2">&quot;bz&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">})</span>
        <span class="n">resolved_reduce_passed</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">reduce_passed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">center_vox</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">_lines_quiet</span><span class="p">(</span><span class="n">maglib</span><span class="p">,</span> <span class="n">seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reduce_passed</span><span class="o">=</span><span class="n">resolved_reduce_passed</span><span class="p">)</span>
        <span class="n">compute_lines_time</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chr_stage_tag</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">stage_prefix</span><span class="si">}</span><span class="s2">.GEN.CHR&quot;</span>

    <span class="n">header</span> <span class="o">=</span> <span class="n">_make_header</span><span class="p">(</span><span class="n">maps</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">maps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">chromo_box</span> <span class="o">=</span> <span class="n">combo_model</span><span class="p">(</span><span class="n">nlfff_box</span><span class="p">,</span> <span class="n">dr3</span><span class="p">,</span> <span class="n">base_bz_arr</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">base_ic_arr</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;codes&quot;</span><span class="p">,</span> <span class="s2">&quot;apex_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;start_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;end_idx&quot;</span><span class="p">,</span> <span class="s2">&quot;seed_idx&quot;</span><span class="p">,</span>
              <span class="s2">&quot;av_field&quot;</span><span class="p">,</span> <span class="s2">&quot;phys_length&quot;</span><span class="p">,</span> <span class="s2">&quot;voxel_status&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
            <span class="n">chromo_box</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">if</span> <span class="s2">&quot;phys_length&quot;</span> <span class="ow">in</span> <span class="n">chromo_box</span><span class="p">:</span>
        <span class="n">chromo_box</span><span class="p">[</span><span class="s2">&quot;phys_length&quot;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">dr3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">chromo_box</span><span class="p">[</span><span class="s2">&quot;attrs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">header</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">goto_chromo</span><span class="p">:</span>
        <span class="n">lines_group</span> <span class="o">=</span> <span class="n">_make_lines_group</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">dr3</span><span class="p">)</span>
        <span class="n">save_stage</span><span class="p">(</span><span class="n">gen_stage_tag</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">,</span> <span class="s2">&quot;lines&quot;</span><span class="p">:</span> <span class="n">lines_group</span><span class="p">})</span>
        <span class="n">stage_times</span><span class="p">[</span><span class="n">gen_stage_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_lines_time</span>
        <span class="k">if</span> <span class="n">cfg</span><span class="o">.</span><span class="n">generic_only</span> <span class="ow">or</span> <span class="n">_last_stage_tag</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">stop_after</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;GEN&quot;</span><span class="p">:</span>
            <span class="n">finalize</span><span class="p">()</span>
            <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Computing </span><span class="si">{</span><span class="n">chr_stage_tag</span><span class="si">}</span><span class="s2"> model...&quot;</span><span class="p">)</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">chr_stage</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;corona&quot;</span><span class="p">:</span> <span class="n">nlfff_box</span><span class="p">,</span> <span class="s2">&quot;chromo&quot;</span><span class="p">:</span> <span class="n">_make_chromo_group</span><span class="p">(</span><span class="n">chromo_box</span><span class="p">)}</span>
    <span class="k">if</span> <span class="n">lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chr_stage</span><span class="p">[</span><span class="s2">&quot;lines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_make_lines_group</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">dr3</span><span class="p">)</span>
    <span class="n">save_stage</span><span class="p">(</span><span class="n">chr_stage_tag</span><span class="p">,</span> <span class="n">chr_stage</span><span class="p">)</span>
    <span class="n">stage_times</span><span class="p">[</span><span class="n">chr_stage_tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span>

    <span class="n">finalize</span><span class="p">()</span></div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="p">()</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, suncast-org.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>